# 人事イベント管理システム

## 🏢 基本方針：一括社員情報インポートによる人事イベント自動判定

### Single Source of Truth
人事システムから出力される社員情報JSONが唯一の真実の源泉

### 運用原則
```
JSONインポート = 人事システムの現在在席者スナップショット
├── JSONに含まれる社員 = 在席中（追加・更新・復職）
├── JSONに含まれない既存社員 = 退職・異動済み（論理削除）
└── 個別の手動追加・削除は原則として行わない
```

## 🔄 人事イベントの自動検出仕様

### 新入社員（追加）
```typescript
判定条件: JSONにあり && DBに存在しない
処理内容: Staff・Contractテーブルに新規作成
```

### 既存社員（更新）
```typescript
判定条件: JSONにあり && DBに存在する
処理内容: 名前・部署・グループ・勤務時間を最新情報に更新
```

### 退職・転出（論理削除・長期管理）
```typescript
判定条件: JSONになし && DBにアクティブで存在
即座処理: isActive=false, deletedAt=現在時刻, Contract論理削除
表示制御: 通常画面から除外、履歴画面ではマスキング機能で制御
長期管理: 5年経過後に自動マスキング (name → "退職者_1234")
重要: 過去のスケジュールデータ（Adjustment）は完全保持
```

### 復職・転入（復活）
```typescript
判定条件: JSONにあり && DB内で論理削除済み
処理内容: isActive=true, deletedAt=null, Contract復活・更新
```

## 🚀 実装済み機能

### APIエンドポイント
- `POST /api/staff/sync-from-json-preview` - 変更内容プレビュー（安全確認）
- `POST /api/staff/sync-from-json` - ファイルアップロード一括同期
- `POST /api/staff/sync-from-json-body` - JSON本体一括同期

### 安全機能
- **プレビュー機能**: 実行前の変更内容確認
- **論理削除**: 物理削除せず復元可能
- **ロールバック**: スナップショット機能による完全復旧
- **監査ログ**: 全変更履歴の記録
- **エラーハンドリング**: 部分失敗時の詳細ログ

## 📊 実行結果例
```json
{
  "summary": {
    "totalImport": 45,
    "added": 3,      // 新入社員
    "updated": 38,   // 既存社員の情報更新  
    "deleted": 2     // 退職・転出者
  },
  "details": {
    "toAdd": [{"empNo": "9001", "name": "新入太郎"}],
    "toDelete": [{"empNo": "8888", "name": "退職花子"}]
  }
}
```

## 🔒 運用ガイドライン

### 人事部門の責任
1. **月次・週次での社員マスタJSON出力**（在席者全員分）
2. **データ正確性の確保**（退職者の除外、新入社員の追加）
3. **緊急時の臨時更新**（即日退職・緊急異動時）

### システム管理者の責任
1. **プレビュー実行による変更内容確認**
2. **異常値・大量変更時のダブルチェック**
3. **同期結果ログの確認・保管**
4. **エラー発生時の調査・対応**

### 推奨運用フロー
```
[月次/週次] 人事システムデータ出力
    ↓
[JSON生成] 在席者全員の最新情報
    ↓
[プレビュー] 変更内容事前確認
    ↓
[承認後] 一括同期実行
    ↓
[結果確認] ログ・統計の確認
```

## ⚠️ 重要な注意事項

### データ整合性
- **JSONファイルの完全性が必須**：一人でも漏れると退職扱いになる
- **empNo（社員番号）の一意性確保**：重複は同期エラーの原因
- **部署・グループ名の統一**：表記ゆれは組織構造の混乱を招く

### タイミング管理
- **厳密性は不要**：入社・退職から1-2週間の遅延は許容
- **明確な人事変更の反映**：明らかに存在しない・追加された人員の処理が目的
- **緊急時対応**：即日退職等は臨時JSON更新で対応

### 安全性確保
- **プレビュー必須**：大量削除・追加時は特に慎重に確認
- **復元可能性**：論理削除により完全な復旧が可能
- **段階的実行**：大量変更時は部分実行も検討

### データ管理方針
- **物理削除禁止**：参照整合性とシステム安定性のため物理削除は実行しない
- **段階的プライバシー保護**：退職後はマスキング機能で制御、5年後に自動マスキング
- **完全履歴保持**：組織の歴史記録として全データを永続保持
- **empNo保持**：業務継続性のため社員番号は常に保持

## 📝 社員情報JSONフォーマット

### インポート用JSONファイル形式
```json
{
  "employeeData": [
    {
      "empNo": "8339",
      "name": "山田美月",
      "dept": "財務情報第一システムサポート課",
      "team": "財務情報第一システムサポート課", 
      "email": "yamada-mitsuki@abc.co.jp",
      "mondayHours": "09:00-18:00",
      "tuesdayHours": "09:00-18:00",
      "wednesdayHours": "09:00-18:00",
      "thursdayHours": "09:00-18:00",
      "fridayHours": "09:00-18:00",
      "saturdayHours": null,
      "sundayHours": null
    },
    {
      "empNo": "7764",
      "name": "加藤優斗",
      "dept": "財務情報第一システムサポート課",
      "team": "財務会計グループ",
      "email": "kato-yuto@abc.co.jp",
      "mondayHours": "09:00-18:00",
      "tuesdayHours": "09:00-18:00", 
      "wednesdayHours": "09:00-18:00",
      "thursdayHours": "09:00-18:00",
      "fridayHours": "09:00-18:00",
      "saturdayHours": null,
      "sundayHours": null
    }
  ]
}
```

### 重要事項
- データは`employeeData`キー内の配列として格納
- `empNo`は文字列形式で主キー
- 勤務時間は`mondayHours`〜`sundayHours`で曜日別に指定
- 休日は`null`で表現
- このフォーマットは変更されていない既存形式

## 🔮 将来拡張計画

### Phase 1: 運用効率化
- **定期自動同期**：指定フォルダ監視による自動実行
- **変更通知機能**：管理者・関係者への自動メール通知
- **人事統計レポート**：月次入退社数・異動数の自動集計

### Phase 2: システム連携
- **人事システム直接連携**：API連携による完全自動化
- **承認ワークフロー**：大量変更時の事前承認プロセス
- **Real-time同期**：人事イベント発生と同時の即座反映

### Phase 3: 高度化
- **AI予測機能**：退職予兆の検出・分析
- **組織分析**：人事データによる組織健全性診断
- **外部連携**：他業務システムとの人事データ共有

## 📋 スケジュールインポート時の社員データ検証

### 本番実装時の必須要件
- スケジュールCSVの各レコードでempNoを社員マスタと照合
- 存在しない社員のスケジュールはスキップ（エラーログに記録）
- インポート結果に「スキップ件数」と「スキップした社員リスト」を含める
- 例：「インポート:1200件、スキップ:149件（存在しない社員）」

---

**関連ドキュメント**: [CLAUDE.md](../../CLAUDE.md)  
**作成日**: 2025-06-26  
**ステータス**: 実装完了