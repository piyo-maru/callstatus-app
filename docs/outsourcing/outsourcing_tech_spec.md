# 技術仕様書 - 出社状況管理ボード

## プロジェクト概要

### システムの目的
300名規模の実企業における出社状況管理とスケジュール調整を目的とした業務システム。受付チームの業務継続性を最優先とし、リアルタイムな情報共有により円滑な業務運営を支援する。

### 重要な設計思想
- **業務継続性優先**: 技術最適化よりも業務の確実性を重視
- **実用性重視**: 300名企業での実運用を前提とした設計
- **リアルタイム性**: 1分単位精度でのリアルタイム更新

## 技術スタック

### フロントエンド
- **Next.js 14**: React フレームワーク
- **TypeScript**: 型安全性の完全対応
- **WebSocket**: リアルタイム通信

### バックエンド
- **NestJS**: Node.js フレームワーク
- **TypeScript**: 型安全性の統一
- **WebSocket**: リアルタイム更新通知

### データベース
- **PostgreSQL**: リレーショナルデータベース

### インフラ
- **Docker**: 開発・運用環境の統一
- **ポート構成**:
  - Frontend: 3000
  - Backend: 3002/3003
  - Database: 5432

## システムアーキテクチャ

### 全体構成
```
Frontend (Next.js) → Backend (NestJS) → Database (PostgreSQL)
     ↓
WebSocket通信によるリアルタイム更新
```

### データフロー
- **REST API**: 主要なデータ操作（CRUD）
- **WebSocket**: リアルタイム更新通知
- **2層データレイヤー**: Contract（契約）+ Adjustment（調整）の統合管理

## 主要機能仕様

### 1. 出社状況管理
- **機能**: リアルタイムタイムライン表示
- **精度**: 1分単位の厳格な時刻管理
- **更新**: WebSocketによるリアルタイム反映
- **制約**: 受付業務要件による最適化制限あり

### 2. 個人スケジュール管理
- **機能**: 月間カレンダー・個人予定管理
- **UI**: 横スクロール統一設計
- **時刻処理**: UTC/JST変換の厳格なルール適用

### 3. 月次計画管理
- **機能**: 承認ワークフロー付き予定作成
- **データ構造**: Contract + Adjustment の2層レイヤー
- **業務フロー**: 計画→調整→承認の段階的処理

### 4. 共通機能
- **横スクロール**: 全3ページで統一された操作性
- **リアルタイム更新**: 全機能でWebSocket対応

## 重要な技術制約と課題

### セキュリティ関連
⚠️ **重要**: 現在バックエンドAPI権限チェックが無効化されています
- **現状**: フロントエンドのみで権限制御を実装
- **脆弱性**: 直接API呼び出しでの制限回避が可能
- **対応**: バックエンドAPI権限チェックの段階的復旧が必要

### パフォーマンス制約
- **WebSocket制限**: 不明（負荷テスト未実施）
- **スケーラビリティ**: 300名企業対応を目標とした設計だが、リアルタイム更新の実際の限界は不明
- **受付業務要件**: 業務継続性を優先し、技術最適化に制限

### 時刻処理の厳格性
- **UTC統一**: 全システムでUTC基準の時刻管理
- **1分単位精度**: TimelineUtils.ts で MINUTES_STEP=1 として定義
- **JST変換**: 厳格なタイムゾーン変換ルール

## 開発チーム向け要求スキル

### 必須スキル
- **TypeScript**: 型安全性の深い理解と開発経験
- **Next.js 14**: 深い理解とベストプラクティスの知識
- **NestJS**: フレームワークの特性理解
- **PostgreSQL**: データベース設計とクエリ最適化

### 重要な理解事項
- **業務コンテキスト**: 技術よりも業務要件の理解を優先
- **実運用視点**: 300名企業での実用性を考慮した開発
- **段階的実装**: 完璧よりも業務継続性を重視した開発アプローチ

## 開発環境

### Docker環境
- **開発環境**: Docker Compose による統一環境
- **各レイヤー**: コンテナ分離による独立性確保
- **依存関係**: package.json による厳密な依存管理

### 開発フロー
1. Docker環境での開発
2. TypeScript による型安全な実装
3. WebSocket機能のテスト
4. 段階的なセキュリティ機能復旧

## 今後の開発計画

### 優先事項
1. **セキュリティ強化**: バックエンドAPI権限チェックの復旧
2. **パフォーマンス改善**: WebSocket最適化による同時接続数向上
3. **機能拡張**: 新規要件への対応

### 技術的負債
- 認証システムの段階的復旧
- WebSocket最適化の制約解除
- セキュリティホールの完全修正

## 注意事項

### 開発時の重要ポイント
- 業務継続性を最優先に考慮した実装
- リアルタイム性の要件を満たす設計
- 既存の業務フローとの整合性確保

### 避けるべき変更
- 時刻処理ロジックの大幅変更
- WebSocketの根本的な設計変更
- 受付チーム要件に影響する機能変更

## 実装済み技術改善一覧

### 時刻処理統一システム
- ✅ **TimeUtilsクラス**: 時刻処理統一ユーティリティ実装
- ✅ **ContractテーブルUTC対応**: `createdAt_utc`, `updatedAt_utc` カラム追加
- ✅ **曜日判定修正**: 環境依存からUTC基準計算へ変更
- ✅ **依存関係統一**: `date-fns` + `date-fns-tz` による標準化
- ✅ **contracts.service.ts修正**: UTC基準の正確な曜日判定実装

### データベーススキーマ拡張
- ✅ **Staffテーブル拡張**: `position`（役職）・`workArrangement`（勤務形態）フィールド追加

---

**文書バージョン**: 1.1.0  
**作成日**: 2025-07-09  
**最終更新**: 2025-07-09（時刻処理統一システム実装）  
**対象**: 開発チーム  
**更新責任者**: 町田　純
