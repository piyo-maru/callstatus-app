# デプロイサーバー要件仕様書 - 出社状況管理ボード

## 概要

出社状況管理ボードを300名企業環境で安定運用するための包括的なサーバー要件を定義する。業務継続性と信頼性を最優先とし、受付チームの重要業務を支える基盤として設計する。

## 1. システム構成要件

### 1.1 アプリケーションアーキテクチャ
```
Frontend (Next.js) ←→ Backend (NestJS) ←→ Database (PostgreSQL)
                    ↓
            WebSocket (Socket.IO)
```

### 1.2 必須コンポーネント
- **Webサーバー**: フロントエンド配信（Next.js production build）
- **アプリケーションサーバー**: バックエンドAPI（NestJS）
- **データベースサーバー**: PostgreSQL 15以上
- **WebSocketサーバー**: Socket.IO（リアルタイム通信）
- **リバースプロキシ**: Nginx/Apache（推奨：Nginx）

## 2. ハードウェア要件

### 2.1 最小構成（300名企業基準）
```yaml
CPU: 4コア（2.5GHz以上）
メモリ: 16GB
ストレージ: 100GB SSD
ネットワーク: 1Gbps
```

### 2.2 推奨構成（安定運用・将来拡張対応）
```yaml
CPU: 8コア（3.0GHz以上）
メモリ: 32GB
ストレージ: 500GB SSD（RAID 1推奨）
ネットワーク: 1Gbps（冗長化推奨）
```

### 2.3 リソース配分
```yaml
フロントエンド: 2GB RAM + 1CPU
バックエンド: 4GB RAM + 2CPU
PostgreSQL: 8GB RAM + 2CPU
システム領域: 4GB RAM + 1CPU
予備リソース: 14GB RAM + 2CPU
```

## 3. ソフトウェア要件

### 3.1 オペレーティングシステム
- **推奨**: Ubuntu 22.04 LTS / CentOS Stream 9
- **最小**: Ubuntu 20.04 LTS / CentOS 8
- **Windows**: Windows Server 2019以上（Docker Desktop必須）

### 3.2 ランタイム環境
- **Node.js**: 18.x LTS（必須）
- **npm**: 9.x以上
- **Docker**: 24.x以上 + Docker Compose v2
- **PostgreSQL**: 15.x以上

### 3.3 ミドルウェア
- **Webサーバー**: Nginx 1.20以上 / Apache 2.4以上
- **プロセス管理**: PM2 / systemd（Docker環境以外）
- **SSL/TLS**: Let's Encrypt / 企業証明書

## 4. ネットワーク・セキュリティ要件

### 4.1 ポート構成
```yaml
HTTP: 80（HTTPS リダイレクト用）
HTTPS: 443（メインアクセス）
API: 3002（内部）
WebSocket: 3002（Socket.IO）
PostgreSQL: 5432（内部のみ）
SSH: 22（管理用）
```

### 4.2 セキュリティ設定
- **ファイアウォール**: ufw / firewalld設定必須
- **SSL/TLS**: TLS 1.2以上強制
- **CORS**: 特定ドメインのみ許可
- **認証**: JWT + bcrypt（実装済み）
- **監査ログ**: 全操作記録（実装済み）

### 4.3 ネットワーク性能
- **同時接続数**: 300接続（全社員想定）
- **WebSocket**: 50-100接続（推定リアルタイム利用者）
- **帯域幅**: 10Mbps以上（アップロード・ダウンロード）

## 5. データベース要件

### 5.1 PostgreSQL設定
```yaml
shared_buffers: 4GB
effective_cache_size: 12GB
maintenance_work_mem: 1GB
max_connections: 200
```

### 5.2 ストレージ要件
```yaml
初期容量: 10GB
年間増加: 5-10GB（履歴データ蓄積）
バックアップ: 同容量（フルバックアップ）
合計推奨: 100GB（3年運用想定）
```

### 5.3 バックアップ戦略
```yaml
方式: pg_dump + WAL継続バックアップ
頻度: フルバックアップ日次、増分は15分間隔
保存期間: 30日（フル）、7日（増分）
復旧目標: RTO 1時間、RPO 15分
```

## 6. パフォーマンス・スケーラビリティ

### 6.1 性能目標
```yaml
応答時間: 
  - API: 200ms以下（平均）
  - ページ読み込み: 2秒以下
  - WebSocket遅延: 100ms以下

スループット:
  - API: 1,000リクエスト/分
  - 同時ユーザー: 100名
  - WebSocket: 50接続（確実動作保証）
```

### 6.2 制限事項（要負荷テスト検証）
```yaml
WebSocket同時接続: 実際の限界値は不明
データベース: 大量履歴データによる性能劣化リスク
メモリ使用量: 長時間運用時の増加傾向要監視
```

### 6.3 スケーラビリティ対応
```yaml
垂直スケーリング:
  - CPU: 16コアまで拡張可能
  - メモリ: 64GBまで拡張可能
  
同一サーバー内スケーリング:
  - WebSocketクラスタリング: 要Redis導入
  - 読み取り専用DB: PostgreSQLレプリケーション
  - CDN: 静的ファイル配信最適化
```

## 7. 可用性・冗長化要件

### 7.1 可用性目標
```yaml
稼働率: 99.5%（月間ダウンタイム3.6時間以内）
メンテナンス窓: 週末夜間2時間
障害復旧: 1時間以内
```

### 7.2 単一サーバー構成（最小構成）
```yaml
UPS: 無停電電源装置（30分以上）
RAID: ストレージ冗長化（RAID 1）
監視: 死活監視・性能監視
自動復旧: systemd / Docker restart policy
```

### 7.3 冗長化構成（推奨）
```yaml
ロードバランサー: HAProxy / Nginx
Webサーバー: 2台構成
DBレプリケーション: Master-Slave構成
共有ストレージ: NAS / SAN
```

## 8. 監視・ログ要件

### 8.1 システム監視
```yaml
メトリクス:
  - CPU使用率（閾値80%）
  - メモリ使用率（閾値85%）
  - ディスク使用率（閾値90%）
  - ネットワーク帯域使用率

監視ツール:
  - Zabbix（推奨）
  - Nagios
  - システム標準（実装済み）
```

### 8.2 アプリケーション監視
```yaml
ログレベル: INFO以上（本番環境）
ログローテーション: 日次、30日保存
ログ容量: 10GB/月想定

監視項目:
  - API応答時間
  - エラー率
  - WebSocket接続数
  - データベース接続プール
```

### 8.3 アラート設定
```yaml
緊急（即時対応）:
  - サービス停止
  - データベース接続不能
  - CPU 95%以上

警告（24時間以内対応）:
  - 応答時間劣化
  - メモリ使用率90%以上
  - WebSocket接続エラー増加
```

## 9. 運用・保守要件

### 9.1 定期メンテナンス
```yaml
日次:
  - バックアップ確認
  - ログ確認
  - 性能監視

週次:
  - セキュリティアップデート
  - ディスク容量確認
  - パフォーマンス分析

月次:
  - フルシステム診断
  - 容量計画見直し
  - 障害対応手順確認
```

### 9.2 アップデート戦略
```yaml
セキュリティパッチ: 緊急適用（1週間以内）
アプリケーション: 段階的デプロイ
データベース: メンテナンス窓での計画実施
Node.js LTS: 年1回の計画アップグレード
```

### 9.3 災害復旧
```yaml
バックアップサイト: 推奨（重要業務のため）
復旧手順書: 詳細手順の文書化必須
復旧テスト: 四半期1回の実施
データ保護: 3-2-1ルール適用推奨
```

## 10. セキュリティ要件

### 10.1 アクセス制御
```yaml
管理者アクセス: SSH鍵認証
アプリケーション: JWT認証（実装済み）
データベース: 専用ユーザー・最小権限
ネットワーク: VPN / 特定IP制限
```

### 10.2 暗号化
```yaml
通信: TLS 1.2以上（HTTPS強制）
データベース: 保存時暗号化推奨
バックアップ: 暗号化必須
パスワード: bcrypt（実装済み）
```

### 10.3 監査・コンプライアンス
```yaml
操作ログ: 全操作記録（実装済み）
アクセスログ: Webサーバー・DB
保存期間: 1年以上
レポート: 月次セキュリティレポート
```

## 11. 業務要件特有の考慮事項

### 11.1 受付チーム業務継続性
```yaml
優先度: 最高（顧客対応への直接影響）
リアルタイム性: 遅延100ms以内
可用性: 平日8:00-18:00は99.9%必須
復旧優先度: 他機能より最優先
```

### 11.2 300名企業規模対応
```yaml
同時利用者: 300名（全社員）
ピーク時間: 9:00-10:00、17:00-18:00
利用パターン: 平日集中、週末最小
成長対応: 300名まで拡張余裕
```

### 11.3 時刻処理の重要性
```yaml
タイムゾーン: JST（UTC+9）表示必須
精度: 1分単位厳格管理
同期: NTPサーバー同期必須
ログ: UTC記録、JST表示
```

## 12. 実装ロードマップ

### 12.1 Phase 1: 基本構築（1-2週間）
- [ ] サーバー調達・OS構築
- [ ] Docker環境構築
- [ ] SSL証明書設定
- [ ] 基本監視設定

### 12.2 Phase 2: アプリケーション配置（1週間）
- [ ] 本番ビルド作成
- [ ] データベース初期化
- [ ] アプリケーション配置
- [ ] 動作確認テスト

### 12.3 Phase 3: 性能・負荷テスト（1-2週間）
- [ ] WebSocket同時接続テスト
- [ ] データベース負荷テスト
- [ ] 長時間運用テスト
- [ ] 障害復旧テスト

### 12.4 Phase 4: 本格運用開始（1週間）
- [ ] ユーザー研修
- [ ] 段階的移行
- [ ] 運用監視開始
- [ ] フィードバック収集

## 13. リスク・制約事項

### 13.1 技術的リスク
```yaml
WebSocket性能: 実際の限界値が不明（負荷テスト必須）
履歴データ: 年間2000万レコード蓄積による性能影響
メモリリーク: 長時間運用での潜在リスク
依存関係: Node.js/npm脆弱性への対応
```

### 13.2 業務リスク
```yaml
受付業務影響: システム停止の顧客満足度への直接影響
移行リスク: 現行システムからの移行時データ損失
運用習熟: 新システムの運用習熟期間
拡張性: 将来的な機能追加への対応
```

### 13.3 対策・軽減策
```yaml
負荷テスト: 本格運用前の徹底的な性能検証
段階移行: リスク最小化のための段階的導入
並行運用: 移行期間の旧システム併用
教育訓練: 運用担当者への十分な教育
```

## 14. 推奨デプロイ構成

### 14.1 単一サーバー構成（最小構成）
```yaml
用途: 300名企業・予算制約がある場合
構成: All-in-One（Web+API+DB）
コスト: 低
可用性: 中
拡張性: 低
```

### 14.2 分離構成（推奨）
```yaml
用途: 安定運用・将来拡張重視
構成: Web+APIサーバー + DBサーバー
コスト: 中
可用性: 高
拡張性: 高
```

### 14.3 クラウド構成（スケーラビリティ重視）
```yaml
用途: 柔軟性・拡張性最優先
構成: マネージドサービス活用
コスト: 高（従量課金）
可用性: 最高
拡張性: 最高
```

---

**文書バージョン**: 1.0.0  
**作成日**: 2025-07-10  
**対象**: システム管理者・インフラエンジニア  
**承認**: 要システム管理者確認・承認

この要件仕様書により、出社状況管理ボードの安定した本番運用環境を構築し、300名企業の重要業務を支える基盤として機能させることが可能になります。特に受付チームの業務継続性を最優先とし、実際の企業環境での運用実績に基づいた現実的な要件定義となっています。