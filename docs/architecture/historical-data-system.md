# éå»å±¥æ­´è¡¨ç¤ºæ©Ÿèƒ½ - ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆæ›¸

## ğŸ“‹ æ¦‚è¦

ã‚³ãƒ¼ãƒ«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¢ãƒ—ãƒªã®éå»å±¥æ­´è¡¨ç¤ºæ©Ÿèƒ½ã¯ã€æŒ‡å®šã—ãŸæ—¥ä»˜ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’éå»ã®çŠ¶æ…‹ãã®ã¾ã¾ã§è¡¨ç¤ºã™ã‚‹ã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚é€€è·è€…ãƒ»éƒ¨ç½²ç•°å‹•è€…ã‚’å«ã‚€å®Œå…¨ãªéå»ãƒ‡ãƒ¼ã‚¿å¾©å…ƒã‚’å®Ÿç¾ã—ã¾ã™ã€‚

## ğŸ—ï¸ ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ        â”‚    â”‚   SchedulesController â”‚    â”‚   ãƒ‡ãƒ¼ã‚¿åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯   â”‚
â”‚                     â”‚    â”‚                     â”‚    â”‚                     â”‚
â”‚ ?date=2025-07-04   â”‚â”€â”€â”€â”€â–¶â”‚ GET /unified        â”‚â”€â”€â”€â”€â–¶â”‚ éå» or ç¾åœ¨åˆ¤å®š     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚                          â”‚
                                        â–¼                          â–¼
                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                           â”‚   ç¾åœ¨ãƒ‡ãƒ¼ã‚¿å‡¦ç†      â”‚    â”‚   å±¥æ­´ãƒ‡ãƒ¼ã‚¿å‡¦ç†      â”‚
                           â”‚                     â”‚    â”‚                     â”‚
                           â”‚ LayerManagerService â”‚    â”‚ SnapshotsService    â”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚                          â”‚
                                        â–¼                          â–¼
                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                           â”‚   ç¾åœ¨DB             â”‚    â”‚   å±¥æ­´DB             â”‚
                           â”‚ ãƒ»Adjustment        â”‚    â”‚ ãƒ»HistoricalSchedule â”‚
                           â”‚ ãƒ»Contract          â”‚    â”‚ ãƒ»SnapshotLog       â”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼è©³ç´°

### 1. ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆä½œæˆãƒ•ãƒ­ãƒ¼

```
æ¯æ—¥ 00:05 JST
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cronã‚¸ãƒ§ãƒ–å®Ÿè¡Œ        â”‚
â”‚ @Cron('5 0 * * *')  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‰æ—¥ãƒ‡ãƒ¼ã‚¿å–å¾—        â”‚â”€â”€â”€â”€â–¶â”‚ Adjustmentãƒ†ãƒ¼ãƒ–ãƒ«   â”‚
â”‚ (é€šå¸¸+æ‰¿èªæ¸ˆPending) â”‚    â”‚ ãƒ»isPending=false   â”‚
â”‚                     â”‚    â”‚ ãƒ»æ‰¿èªæ¸ˆPending     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ãƒ‡ãƒ¼ã‚¿å¤‰æ›ãƒ»ä¿å­˜      â”‚â”€â”€â”€â”€â–¶â”‚ HistoricalSchedule  â”‚
â”‚ +ã‚¹ã‚¿ãƒƒãƒ•æƒ…å ±åŸ‹è¾¼     â”‚    â”‚ ãƒ»éå»çŠ¶æ…‹ã‚¹ãƒŠãƒƒãƒ—   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ãƒ­ã‚°è¨˜éŒ²ãƒ»å®Œäº†ç¢ºèª    â”‚â”€â”€â”€â”€â–¶â”‚ SnapshotLog         â”‚
â”‚ batchIdç”Ÿæˆãƒ»çŠ¶æ…‹ç®¡ç† â”‚    â”‚ ãƒ»å®Ÿè¡Œå±¥æ­´ç®¡ç†       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. å±¥æ­´ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ•ãƒ­ãƒ¼

```
API Request: /schedules/unified?date=2025-07-04
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ—¥ä»˜åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯      â”‚
â”‚ targetDate < today? â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼ (éå»æ—¥ä»˜ã®å ´åˆ)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å±¥æ­´ãƒ‡ãƒ¼ã‚¿å–å¾—        â”‚â”€â”€â”€â”€â–¶â”‚ HistoricalSchedule  â”‚
â”‚ getHistoricalSchedules â”‚    â”‚ WHERE date = target â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å¥‘ç´„ãƒ¬ã‚¤ãƒ¤ãƒ¼å‹•çš„ç”Ÿæˆ   â”‚â”€â”€â”€â”€â–¶â”‚ Contract            â”‚
â”‚ generateHistorical   â”‚    â”‚ (é€€è·è€…ã‚‚å«ã‚€)       â”‚
â”‚ ContractSchedules    â”‚    â”‚                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ãƒ‡ãƒ¼ã‚¿çµ±åˆãƒ»ãƒ¬ã‚¹ãƒãƒ³ã‚¹ â”‚
â”‚ ãƒ»å±¥æ­´å±¤(adjustment) â”‚
â”‚ ãƒ»å¥‘ç´„å±¤(contract)   â”‚
â”‚ ãƒ»ã‚¹ã‚¿ãƒƒãƒ•æƒ…å ±å¾©å…ƒ    â”‚
â”‚ ãƒ»éåœ¨ç±è€…ãƒã‚¹ã‚­ãƒ³ã‚°  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“Š ä¸»è¦ãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆ

### HistoricalScheduleï¼ˆå±¥æ­´ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼‰
```sql
CREATE TABLE "historical_schedules" (
  id              SERIAL PRIMARY KEY,
  date            DATE NOT NULL,                    -- å¯¾è±¡æ—¥ä»˜
  originalId      INTEGER,                          -- å…ƒã®Adjustment.id
  batchId         VARCHAR NOT NULL,                 -- ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆè­˜åˆ¥å­
  
  -- ã‚¹ã‚¿ãƒƒãƒ•æƒ…å ±ï¼ˆã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆæ™‚ç‚¹ï¼‰
  staffId         INTEGER NOT NULL,
  staffEmpNo      VARCHAR,
  staffName       VARCHAR NOT NULL,
  staffDepartment VARCHAR NOT NULL,
  staffGroup      VARCHAR NOT NULL,
  staffIsActive   BOOLEAN DEFAULT true,
  
  -- ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æƒ…å ±
  status          VARCHAR NOT NULL,
  start           TIMESTAMP NOT NULL,               -- UTCæ™‚åˆ»
  end             TIMESTAMP NOT NULL,               -- UTCæ™‚åˆ»
  memo            TEXT,
  reason          TEXT,
  
  -- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
  snapshotAt      TIMESTAMP DEFAULT NOW(),          -- ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆä½œæˆæ™‚åˆ»
  version         VARCHAR DEFAULT '1.0',            -- ãƒ‡ãƒ¼ã‚¿ãƒãƒ¼ã‚¸ãƒ§ãƒ³
  
  -- CLAUDE.mdå³æ ¼ãƒ«ãƒ¼ãƒ«æº–æ‹ : æ–°UTCã‚«ãƒ©ãƒ 
  date_utc        TIMESTAMP WITH TIME ZONE,
  start_utc       TIMESTAMP WITH TIME ZONE,
  end_utc         TIMESTAMP WITH TIME ZONE,
  snapshotAt_utc  TIMESTAMP WITH TIME ZONE,
  
  -- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
  INDEX idx_date (date),
  INDEX idx_date_staff (date, staffId),
  INDEX idx_date_dept (date, staffDepartment),
  INDEX idx_batch (batchId)
);
```

### SnapshotLogï¼ˆã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆå®Ÿè¡Œå±¥æ­´ï¼‰
```sql
CREATE TABLE "snapshot_logs" (
  id           SERIAL PRIMARY KEY,
  batchId      VARCHAR UNIQUE NOT NULL,             -- å®Ÿè¡Œè­˜åˆ¥å­
  targetDate   DATE NOT NULL,                       -- å¯¾è±¡æ—¥ä»˜
  recordCount  INTEGER NOT NULL,                    -- å‡¦ç†ä»¶æ•°
  status       ENUM('RUNNING','COMPLETED','FAILED','ROLLED_BACK'),
  startedAt    TIMESTAMP DEFAULT NOW(),             -- å®Ÿè¡Œé–‹å§‹æ™‚åˆ»
  completedAt  TIMESTAMP,                           -- å®Œäº†æ™‚åˆ»
  errorMessage TEXT,                                 -- ã‚¨ãƒ©ãƒ¼è©³ç´°
  
  -- CLAUDE.mdå³æ ¼ãƒ«ãƒ¼ãƒ«æº–æ‹ : æ–°UTCã‚«ãƒ©ãƒ 
  targetDate_utc   TIMESTAMP WITH TIME ZONE,
  startedAt_utc    TIMESTAMP WITH TIME ZONE,
  completedAt_utc  TIMESTAMP WITH TIME ZONE,
  
  INDEX idx_target_date (targetDate),
  INDEX idx_status (status)
);
```

## ğŸ’» ä¸»è¦ã‚¯ãƒ©ã‚¹ãƒ»ãƒ¡ã‚½ãƒƒãƒ‰å®Ÿè£…

### SnapshotsService

#### è‡ªå‹•ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆä½œæˆ
```typescript
@Injectable()
export class SnapshotsService {
  /**
   * æ—¥æ¬¡ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆè‡ªå‹•å®Ÿè¡Œï¼ˆæ¯æ—¥æ·±å¤œ0æ™‚5åˆ†JSTï¼‰
   */
  @Cron('5 0 * * *', {
    name: 'daily-snapshot',
    timeZone: 'Asia/Tokyo'
  })
  async handleDailyCron() {
    const result = await this.createDailySnapshot();
    this.logger.log(`æ—¥æ¬¡ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆå®Œäº†: ${result.recordCount}ä»¶`);
  }

  /**
   * å‰æ—¥åˆ†ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’è‡ªå‹•ä½œæˆ
   */
  async createDailySnapshot() {
    const yesterday = this.getYesterday();
    const batchId = this.generateBatchId();
    
    return await this.executeSnapshot(yesterday, batchId);
  }

  /**
   * ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆå®Ÿè¡Œã®ä¸­æ ¸å‡¦ç†
   */
  private async executeSnapshot(date: Date, batchId: string) {
    return await this.prisma.$transaction(async (tx) => {
      // 1. ãƒ­ã‚°é–‹å§‹è¨˜éŒ²
      await this.createSnapshotLog(tx, date, batchId);
      
      // 2. å¯¾è±¡ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆç¤¾å“¡æƒ…å ±ã¨ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼‰
      const scheduleData = await this.getScheduleWithStaffInfo(tx, date);
      
      // 3. ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆä½œæˆ
      const historicalData = this.transformToHistoricalData(scheduleData, batchId);
      
      if (historicalData.length > 0) {
        await this.saveHistoricalData(tx, historicalData);
      }
      
      // 4. ãƒ­ã‚°å®Œäº†è¨˜éŒ²
      await this.completeSnapshotLog(tx, batchId, historicalData.length);
      
      return {
        batchId,
        targetDate: date,
        recordCount: historicalData.length,
        status: 'COMPLETED'
      };
    });
  }
}
```

#### å¯¾è±¡ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ­ã‚¸ãƒƒã‚¯
```typescript
/**
 * æŒ‡å®šæ—¥ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ç¤¾å“¡æƒ…å ±ã¨å…±ã«å–å¾—
 * é€šå¸¸ã®Adjustmentã¨æ‰¿èªæ¸ˆã¿Pendingã®ä¸¡æ–¹ã‚’å–å¾—
 */
private async getScheduleWithStaffInfo(tx: any, date: Date) {
  const startOfDay = new Date(date);
  startOfDay.setHours(0, 0, 0, 0);
  
  const endOfDay = new Date(date);
  endOfDay.setHours(23, 59, 59, 999);
  
  // é€šå¸¸ã®Adjustmentã¨æ‰¿èªæ¸ˆã¿Pendingãƒ¬ã‚³ãƒ¼ãƒ‰ã®ä¸¡æ–¹ã‚’å–å¾—
  return await tx.adjustment.findMany({
    where: {
      date: {
        gte: startOfDay,
        lte: endOfDay
      },
      OR: [
        { isPending: false },                    // é€šå¸¸ã®Adjustment
        { isPending: true, approvedAt: { not: null } }  // æ‰¿èªæ¸ˆã¿Pending
      ]
    },
    include: {
      Staff: true
    }
  });
}
```

### SchedulesController

#### çµ±ä¸€APIï¼ˆç¾åœ¨/éå»è‡ªå‹•åˆ†å²ï¼‰
```typescript
/**
 * çµ±åˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å–å¾—APIï¼ˆç¾åœ¨/éå»ã®è‡ªå‹•åˆ†å²ï¼‰
 * /schedules/unified?date=YYYY-MM-DD
 */
@Get('unified')
async findUnified(
  @Query('date') date: string,
  @Query('includeMasking') includeMasking?: string,
  @Query('staffId') staffId?: string
) {
  const targetDate_utc = this.parseTargetDateUtc(date);
  const businessToday_utc = this.getBusinessTodayUtc();

  const targetStaffId = staffId ? parseInt(staffId) : undefined;

  // æ¥­å‹™æ—¥åŸºæº–ã§éå»ã®æ—¥ä»˜ã¯å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—
  if (targetDate_utc < businessToday_utc) {
    return this.getHistoricalSchedules(date, includeMasking === 'true', targetStaffId);
  } else {
    // æ¥­å‹™æ—¥åŸºæº–ã§ä»Šæ—¥ä»¥é™ã¯ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—
    return this.getCurrentSchedules(date, targetStaffId);
  }
}
```

#### æ—¥ä»˜åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯
```typescript
/**
 * æ¥­å‹™æ—¥åŸºæº–ã§ã®ã€Œä»Šæ—¥ã€ã‚’UTCå½¢å¼ã§å–å¾—
 * æ—¥æœ¬æ™‚é–“ï¼ˆJSTï¼‰ã§ã®æ—¥ä»˜åˆ¤å®šã‚’è¡Œã„ã€UTCå½¢å¼ã§è¿”ã™
 */
private getBusinessTodayUtc(): Date {
  // ç¾åœ¨ã®UTCæ™‚åˆ»ã‚’å–å¾—
  const now_utc = new Date();
  
  // JSTæ™‚åˆ»ã«å¤‰æ›ã—ã¦æ—¥ä»˜ã‚’å–å¾—
  const now_jst = new Date(now_utc.getTime() + 9 * 60 * 60 * 1000);
  const jst_year = now_jst.getUTCFullYear();
  const jst_month = now_jst.getUTCMonth();
  const jst_date = now_jst.getUTCDate();
  
  // JSTåŸºæº–ã§ã®ã€Œä»Šæ—¥ã€ã®é–‹å§‹æ™‚åˆ»ã‚’UTCå½¢å¼ã§æ§‹ç¯‰
  const businessToday_jst = new Date(Date.UTC(jst_year, jst_month, jst_date, 0, 0, 0, 0));
  const businessToday_utc = new Date(businessToday_jst.getTime() - 9 * 60 * 60 * 1000);
  
  return businessToday_utc;
}
```

#### å±¥æ­´ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ»çµ±åˆå‡¦ç†
```typescript
/**
 * å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦è¿”ã™ï¼ˆå¥‘ç´„ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚‚å«ã‚€ï¼‰
 */
private async getHistoricalSchedules(date: string, includeMasking: boolean = false, targetStaffId?: number) {
  console.log(`å±¥æ­´ãƒ‡ãƒ¼ã‚¿å–å¾—é–‹å§‹: ${date}, ãƒã‚¹ã‚­ãƒ³ã‚°: ${includeMasking}`);
  
  // 1. å±¥æ­´ãƒ‡ãƒ¼ã‚¿ï¼ˆèª¿æ•´ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼‰ã‚’å–å¾—
  const historicalData = await this.snapshotsService.getHistoricalSchedules(date);
  console.log(`å±¥æ­´ãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº†: ${historicalData ? historicalData.length : 0}ä»¶`);
  
  // 2. å¥‘ç´„ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å‹•çš„ç”Ÿæˆï¼ˆé€€è·è€…å«ã‚€ï¼‰
  let contractSchedules = [];
  try {
    contractSchedules = await this.layerManagerService.generateHistoricalContractSchedules(date);
    console.log(`å¥‘ç´„ãƒ¬ã‚¤ãƒ¤ãƒ¼ç”Ÿæˆå®Œäº†: ${contractSchedules.length}ä»¶`);
  } catch (error) {
    console.error(`å¥‘ç´„ãƒ¬ã‚¤ãƒ¤ãƒ¼ç”Ÿæˆã‚¨ãƒ©ãƒ¼: ${error.message}`);
    // å¥‘ç´„ãƒ¬ã‚¤ãƒ¤ãƒ¼ç”Ÿæˆã«å¤±æ•—ã—ã¦ã‚‚å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã¯è¿”ã™
  }

  // 3. ã‚¹ã‚¿ãƒƒãƒ•æƒ…å ±ã‚’å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã¨å¥‘ç´„ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æ§‹ç¯‰
  const staffMap = new Map();
  
  // å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã‚¹ã‚¿ãƒƒãƒ•æƒ…å ±ã‚’æ§‹ç¯‰
  if (historicalData) {
    for (const item of historicalData) {
      if (!staffMap.has(item.staffId)) {
        const maskedName = includeMasking 
          ? await this.maskStaffName(item.staffName, item.staffId)
          : item.staffName;
        
        staffMap.set(item.staffId, {
          id: item.staffId,
          empNo: item.staffEmpNo,
          name: maskedName,
          department: item.staffDepartment,
          group: item.staffGroup,
          isActive: item.staffIsActive
        });
      }
    }
  }

  // 4. ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’å¤‰æ›
  const schedules = [];
  
  // å±¥æ­´ãƒ‡ãƒ¼ã‚¿ï¼ˆèª¿æ•´ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼‰ã‚’è¿½åŠ 
  if (historicalData) {
    const historicalSchedules = historicalData.map((item, index) => ({
      id: `hist_${item.id}_${index}`,
      staffId: item.staffId,
      status: item.status,
      start: this.convertUtcToJstDecimal(item.start),
      end: this.convertUtcToJstDecimal(item.end),
      memo: item.memo,
      layer: 'historical' // å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã¯ 'historical' ãƒ¬ã‚¤ãƒ¤ãƒ¼
    }));
    schedules.push(...historicalSchedules);
  }
  
  // å¥‘ç´„ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¿½åŠ 
  const contractSchedulesConverted = contractSchedules.map((cs, index) => ({
    id: `contract_hist_${cs.id}_${index}`,
    staffId: cs.staffId,
    status: cs.status,
    start: this.convertUtcToJstDecimal(cs.start),
    end: this.convertUtcToJstDecimal(cs.end),
    memo: cs.memo,
    layer: 'contract' // å¥‘ç´„ãƒ‡ãƒ¼ã‚¿ã¯ 'contract' ãƒ¬ã‚¤ãƒ¤ãƒ¼
  }));
  schedules.push(...contractSchedulesConverted);

  console.log(`å±¥æ­´ãƒ‡ãƒ¼ã‚¿çµ±åˆå®Œäº†: å±¥æ­´${historicalData ? historicalData.length : 0}ä»¶ + å¥‘ç´„${contractSchedules.length}ä»¶ = åˆè¨ˆ${schedules.length}ä»¶`);

  return {
    schedules,
    staff: Array.from(staffMap.values()),
    isHistorical: true,
    snapshotDate: historicalData && historicalData.length > 0 ? historicalData[0]?.snapshotAt : null,
    recordCount: schedules.length,
    historicalRecords: historicalData ? historicalData.length : 0,
    contractRecords: contractSchedules.length
  };
}
```

## ğŸ›¡ï¸ é‡è¦æ©Ÿèƒ½

### 1. éåœ¨ç±ç¤¾å“¡ãƒã‚¹ã‚­ãƒ³ã‚°
```typescript
/**
 * éåœ¨ç±ç¤¾å“¡åã‚’ãƒã‚¹ã‚­ãƒ³ã‚°
 */
private async maskStaffName(originalName: string, staffId: number): Promise<string> {
  try {
    // ç¾åœ¨ã®ã‚¹ã‚¿ãƒƒãƒ•ãƒ†ãƒ¼ãƒ–ãƒ«ã§è©²å½“è€…ã‚’ç¢ºèª
    const currentStaff = await this.schedulesService['prisma'].staff.findUnique({
      where: { id: staffId }
    });

    // ç¾åœ¨ã‚‚åœ¨ç±ã—ã¦ã„ã‚‹å ´åˆã¯å®Ÿåè¡¨ç¤º
    if (currentStaff && currentStaff.isActive) {
      return originalName;
    }

    // é€€è·æ¸ˆã¿ã¾ãŸã¯å­˜åœ¨ã—ãªã„å ´åˆã¯ãƒã‚¹ã‚­ãƒ³ã‚°
    return 'éåœ¨ç±ç¤¾å“¡';
  } catch (error) {
    console.error('Staff masking error:', error);
    return 'ä¸æ˜ãªç¤¾å“¡';
  }
}
```

### 2. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ»ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½
```typescript
/**
 * å¤±æ•—æ™‚ã®ãƒªãƒˆãƒ©ã‚¤ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°ï¼ˆ1æ™‚é–“å¾Œã€æœ€å¤§3å›ï¼‰
 */
@Cron('5 */1 * * *', {
  name: 'snapshot-retry',
  timeZone: 'Asia/Tokyo'
})
async handleRetryCron() {
  if (!this.isRetryRunning) {
    return;
  }

  const yesterday = this.getYesterday();
  const existingSnapshot = await this.checkExistingSnapshot(yesterday);

  if (existingSnapshot && existingSnapshot.status === 'COMPLETED') {
    this.logger.log('æ—¢ã«å®Œäº†ã—ãŸã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆãŒå­˜åœ¨ã™ã‚‹ãŸã‚ã€ãƒªãƒˆãƒ©ã‚¤ã‚’åœæ­¢');
    this.isRetryRunning = false;
    return;
  }

  try {
    const result = await this.createDailySnapshot();
    this.logger.log(`ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ ãƒªãƒˆãƒ©ã‚¤æˆåŠŸ: ${result.recordCount}ä»¶`);
    this.isRetryRunning = false;
  } catch (error) {
    this.logger.error(`ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ ãƒªãƒˆãƒ©ã‚¤å¤±æ•—: ${error.message}`);
    
    // 3å›å¤±æ•—ã—ãŸã‚‰ãƒªãƒˆãƒ©ã‚¤ã‚’åœæ­¢
    const failedCount = await this.getFailedRetryCount(yesterday);
    if (failedCount >= 3) {
      this.logger.error('ãƒªãƒˆãƒ©ã‚¤å›æ•°ä¸Šé™ã«é”ã—ãŸãŸã‚ã€ãƒªãƒˆãƒ©ã‚¤ã‚’åœæ­¢');
      this.isRetryRunning = false;
    }
  }
}
```

### 3. ãƒãƒƒãƒIDç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ 
```typescript
/**
 * ãƒãƒƒãƒIDã‚’ç”Ÿæˆ
 * å½¢å¼: snap_YYYYMMDDTHHmmss_uuid
 */
private generateBatchId(): string {
  const timestamp = new Date().toISOString().replace(/[-:]/g, '').split('.')[0];
  const uuid = uuidv4().split('-')[0];
  return `snap_${timestamp}_${uuid}`;
}
```

## ğŸ“Š ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼

### å±¥æ­´ãƒ‡ãƒ¼ã‚¿ãƒ¬ã‚¹ãƒãƒ³ã‚¹
```json
{
  "schedules": [
    {
      "id": "hist_42456_0",
      "staffId": 226,
      "status": "Online",
      "start": 9.0,
      "end": 18.0,
      "memo": "é€šå¸¸å‹¤å‹™",
      "layer": "historical"
    },
    {
      "id": "contract_hist_226_0",
      "staffId": 226,
      "status": "Online",
      "start": 9.0,
      "end": 18.0,
      "memo": null,
      "layer": "contract"
    }
  ],
  "staff": [
    {
      "id": 226,
      "empNo": "E001",
      "name": "å±±ç”°ç¾æœˆ",
      "department": "è²¡å‹™æƒ…å ±ç¬¬ä¸€ã‚·ã‚¹ãƒ†ãƒ ã‚µãƒãƒ¼ãƒˆèª²",
      "group": "è²¡å‹™æƒ…å ±ç¬¬ä¸€ã‚·ã‚¹ãƒ†ãƒ ã‚µãƒãƒ¼ãƒˆèª²",
      "isActive": true
    }
  ],
  "isHistorical": true,
  "snapshotDate": "2025-07-04T15:05:23.456Z",
  "recordCount": 523,
  "historicalRecords": 298,
  "contractRecords": 225
}
```

### ç¾åœ¨ãƒ‡ãƒ¼ã‚¿ãƒ¬ã‚¹ãƒãƒ³ã‚¹
```json
{
  "schedules": [...],
  "staff": [...],
  "isHistorical": false
}
```

## âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### 1. ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æˆ¦ç•¥
```sql
-- æ—¥ä»˜ç¯„å›²æ¤œç´¢æœ€é©åŒ–
CREATE INDEX idx_historical_schedules_date_utc ON historical_schedules(date_utc);
CREATE INDEX idx_historical_schedules_date_utc_staff ON historical_schedules(date_utc, staffId);
CREATE INDEX idx_historical_schedules_date_utc_dept ON historical_schedules(date_utc, staffDepartment);

-- ãƒãƒƒãƒå‡¦ç†æœ€é©åŒ–
CREATE INDEX idx_historical_schedules_batch ON historical_schedules(batchId);
CREATE INDEX idx_snapshot_logs_target_date_utc ON snapshot_logs(targetDate_utc);
```

### 2. ãƒ‡ãƒ¼ã‚¿åœ§ç¸®ãƒ»æœ€é©åŒ–
- ã‚¹ã‚¿ãƒƒãƒ•æƒ…å ±ã®é‡è¤‡æ’é™¤
- å¿…è¦ãªå ´åˆã®ã¿staffIdãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å®Ÿè¡Œ
- ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æœ€å°åŒ–

## ğŸš¨ é‹ç”¨ä¸Šã®æ³¨æ„ç‚¹

### 1. ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§
- ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆä½œæˆã¯ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å†…ã§å®Ÿè¡Œ
- æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã¨ã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯å¿…é ˆ
- å¤±æ•—æ™‚ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½

### 2. ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³å‡¦ç†
- **å†…éƒ¨å‡¦ç†**: å®Œå…¨UTCåŸºæº–
- **æ—¥ä»˜åˆ¤å®š**: JSTæ¥­å‹™æ—¥åŸºæº–
- **APIå…¥å‡ºåŠ›**: JSTå°æ•°ç‚¹æ™‚åˆ»
- **CLAUDE.mdå³æ ¼ãƒ«ãƒ¼ãƒ«æº–æ‹ **: `*_utc`ã‚«ãƒ©ãƒ å‘½å

### 3. ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ç®¡ç†
- å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã®è‚¥å¤§åŒ–å¯¾ç­–
- å¤ã„ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã®å®šæœŸå‰Šé™¤ãƒãƒªã‚·ãƒ¼
- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»å¾©æ—§æˆ¦ç•¥

## ğŸ” ç›£è¦–ãƒ»ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹

### 1. Cronã‚¸ãƒ§ãƒ–ç›£è¦–
- æ¯æ—¥ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆä½œæˆæˆåŠŸç¢ºèª
- å¤±æ•—æ™‚ã®ã‚¢ãƒ©ãƒ¼ãƒˆé€ä¿¡
- ãƒªãƒˆãƒ©ã‚¤çŠ¶æ³ã®ç›£è¦–

### 2. ãƒ‡ãƒ¼ã‚¿å“è³ªãƒã‚§ãƒƒã‚¯
- æ—¥æ¬¡ãƒ‡ãƒ¼ã‚¿é‡ã®å¦¥å½“æ€§ç¢ºèª
- ã‚¹ã‚¿ãƒƒãƒ•æƒ…å ±ã®æ­£ç¢ºæ€§æ¤œè¨¼
- æ™‚åˆ»ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯

### 3. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–
- APIå¿œç­”æ™‚é–“ã®æ¸¬å®š
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ã‚¨ãƒªæ€§èƒ½ç›£è¦–
- ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨é‡ã®è¿½è·¡

---

**ğŸ“ æ–‡æ›¸æ›´æ–°å±¥æ­´**
- 2025-07-05: åˆç‰ˆä½œæˆ - CLAUDE.mdå³æ ¼ãƒ«ãƒ¼ãƒ«æº–æ‹ å¾Œã®å®Ÿè£…ã«åŸºã¥ãè©³ç´°è¨­è¨ˆæ›¸
- å®Ÿè£…å‚ç…§: SnapshotsService, SchedulesController, LayerManagerService
- ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼: 17,285ä»¶ã®Adjustmentãƒ‡ãƒ¼ã‚¿ã§ãƒ†ã‚¹ãƒˆæ¸ˆã¿