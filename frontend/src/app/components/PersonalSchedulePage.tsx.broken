'use client';

import React, { useState, useEffect, useMemo, useCallback, Fragment } from 'react';
import { format, addDays, startOfMonth, endOfMonth, eachDayOfInterval, isSameDay, isToday } from 'date-fns';
import { ja } from 'date-fns/locale';
import { createPortal } from 'react-dom';
import { useAuth } from './AuthProvider';
// â˜…â˜…â˜… ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ â˜…â˜…â˜…
import {
  timeToPositionPercent,
  positionPercentToTime,
  generateTimeOptions,
  STATUS_COLORS,
  TIMELINE_CONFIG,
  capitalizeStatus,
  getCurrentTimePosition,
  Schedule as TimelineSchedule,
  Staff as TimelineStaff
} from './timeline/TimelineUtils';

// TimelineUtils ã‹ã‚‰ã‚¿ã‚¤ãƒ—ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¤ã¤ã€å€‹äººãƒšãƒ¼ã‚¸å›ºæœ‰ã®æ‹¡å¼µã‚’è¿½åŠ 
interface Schedule extends TimelineSchedule {
  staffName: string;
  staffDepartment: string;
  staffGroup: string;
  empNo?: string;
  date?: string;
}

interface Staff extends TimelineStaff {
  // å€‹äººãƒšãƒ¼ã‚¸ã§ã¯åŸºæœ¬ã‚¿ã‚¤ãƒ—ã¨åŒä¸€
}

interface StaffDetails {
  id: number;
  empNo?: string;
  name: string;
  department: string;
  group: string;
  isActive: boolean;
  contract: {
    empNo: string;
    email: string;
    workingDays: string[];
    employmentType: 'REGULAR' | 'PART_TIME' | 'CONTRACT';
  } | null;
}

interface PresetSchedule {
  id: string;
  name: string;
  status: string;
  startTime: number; // å°æ•°ç‚¹æ™‚åˆ»ï¼ˆä¾‹: 9.5 = 9:30ï¼‰
  endTime: number;
  memo?: string;
  // è¤‡æ•°ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å¯¾å¿œï¼ˆå¤œé–“å‹¤å‹™ç”¨ï¼‰
  multiSchedules?: Array<{
    status: string;
    startTime: number;
    endTime: number;
    memo?: string;
  }>;
}

interface PresetButtonProps {
  preset: PresetSchedule;
  targetDate: Date;
  onAdd: (preset: PresetSchedule, date: Date) => void;
  disabled?: boolean;
}

// ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°ã¯ TimelineUtils ã‹ã‚‰ä½¿ç”¨
const availableStatuses = ['online', 'remote', 'meeting', 'training', 'break', 'off', 'unplanned', 'night duty'];

const PersonalSchedulePage: React.FC = () => {
  const { user, loading: authLoading } = useAuth();
  const [selectedDate, setSelectedDate] = useState(new Date());
  const [schedules, setSchedules] = useState<Schedule[]>([]);
  const [currentStaff, setCurrentStaff] = useState<Staff | null>(null);
  const [staffDetails, setStaffDetails] = useState<StaffDetails | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [selectedDateForPreset, setSelectedDateForPreset] = useState<Date | null>(null);
  const [showPresetModal, setShowPresetModal] = useState(false);
  
  // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—é–¢é€£ã®çŠ¶æ…‹ï¼ˆãƒ¡ã‚¤ãƒ³ç”»é¢ã¨åŒã˜ï¼‰
  const [dragInfo, setDragInfo] = useState<{
    date: Date;
    startX: number;
    currentX: number;
    rowRef: HTMLDivElement;
  } | null>(null);
  
  // ãƒ‰ãƒ©ãƒƒã‚°ã•ã‚ŒãŸã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®çŠ¶æ…‹
  const [draggedSchedule, setDraggedSchedule] = useState<(Partial<Schedule> & { date?: string }) | null>(null);
  const [dragOffset, setDragOffset] = useState(0);
  const [selectedSchedule, setSelectedSchedule] = useState<{ schedule: Schedule; layer: string } | null>(null);
  
  // ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£ã®çŠ¶æ…‹
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [editingSchedule, setEditingSchedule] = useState<Schedule | null>(null);
  const [deletingScheduleId, setDeletingScheduleId] = useState<number | null>(null);
  
  // è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰çŠ¶æ…‹ç®¡ç†ï¼ˆãƒ¡ã‚¤ãƒ³ç”»é¢ã¨åŒæ§˜ï¼‰
  const [viewMode, setViewMode] = useState<'normal' | 'compact'>(() => {
    if (typeof window !== 'undefined') {
      return (localStorage.getItem('callstatus-viewMode') as 'normal' | 'compact') || 'normal';
    }
    return 'normal';
  });
  
  // viewModeå¤‰æ›´æ™‚ã®localStorageæ›´æ–°
  useEffect(() => {
    if (typeof window !== 'undefined') {
      localStorage.setItem('callstatus-viewMode', viewMode);
    }
  }, [viewMode]);
  
  // è¡Œã®é«˜ã•ã‚’å‹•çš„ã«æ±ºå®šï¼ˆãƒ¡ã‚¤ãƒ³ç”»é¢ã¨åŒæ§˜ï¼‰
  const getRowHeight = useCallback(() => {
    return viewMode === 'compact' ? 'h-8' : 'h-[45px]';
  }, [viewMode]);
  
  // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒãƒ¼ã®é«˜ã•ã‚’å‹•çš„ã«æ±ºå®š
  const getScheduleBarHeight = useCallback(() => {
    return viewMode === 'compact' ? 'h-4' : 'h-6';
  }, [viewMode]);
  
  // ç·¨é›†æ¨©é™ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ¡ã‚¤ãƒ³ç”»é¢ã¨åŒæ§˜ï¼‰
  const canEdit = useCallback((scheduleStaffId: number): boolean => {
    return currentStaff?.id === scheduleStaffId;
  }, [currentStaff]);
  
  // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚ªãƒ¼ãƒ—ãƒ³å‡¦ç†ï¼ˆãƒ¡ã‚¤ãƒ³ç”»é¢ã¨åŒæ§˜ï¼‰
  const handleOpenModal = useCallback((schedule: Schedule) => {
    setEditingSchedule(schedule);
    setDraggedSchedule(null);
    setIsModalOpen(true);
  }, []);
  
  

  // ãƒ—ãƒªã‚»ãƒƒãƒˆäºˆå®šï¼ˆå¾Œã§ç®¡ç†ç”»é¢ã‹ã‚‰è¨­å®šå¯èƒ½ã«ã™ã‚‹ï¼‰
  const presetSchedules: PresetSchedule[] = [
    { id: 'remote-work', name: 'åœ¨å®…å‹¤å‹™', status: 'remote', startTime: 9, endTime: 18 },
    { 
      id: 'night-duty', 
      name: 'å¤œé–“', 
      status: 'night duty', 
      startTime: 18, 
      endTime: 21,
      multiSchedules: [
        { status: 'night duty', startTime: 18, endTime: 21 },
        { status: 'off', startTime: 9, endTime: 13 },
        { status: 'break', startTime: 17, endTime: 18 }
      ]
    },
    { id: 'vacation', name: 'ä¼‘æš‡', status: 'off', startTime: 9, endTime: 18 },
    { id: 'morning-off', name: 'åˆå‰ä¼‘', status: 'off', startTime: 9, endTime: 13 },
    { id: 'afternoon-off', name: 'åˆå¾Œä¼‘', status: 'off', startTime: 12, endTime: 18 },
    { id: 'early-leave', name: 'æ—©é€€', status: 'unplanned', startTime: 12, endTime: 18 },
  ];

  // æœˆé–“ã®æ—¥ä»˜ãƒªã‚¹ãƒˆã‚’ç”Ÿæˆ
  const monthDays = useMemo(() => {
    const start = startOfMonth(selectedDate);
    const end = endOfMonth(selectedDate);
    return eachDayOfInterval({ start, end });
  }, [selectedDate]);

  // ç¾åœ¨æ™‚åˆ»
  const [currentTime, setCurrentTime] = useState(new Date());
  
  useEffect(() => {
    const timer = setInterval(() => {
      setCurrentTime(new Date());
    }, 60000); // 1åˆ†ã”ã¨ã«æ›´æ–°
    
    return () => clearInterval(timer);
  }, []);

  // æ™‚é–“ä½ç½®è¨ˆç®—é–¢æ•°ã¯ TimelineUtils ã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ¸ˆã¿
  // timeToPositionPercent, positionPercentToTime ã‚’ç›´æ¥ä½¿ç”¨

  // APIãƒ™ãƒ¼ã‚¹URLã‚’å–å¾—
  const getApiUrl = useCallback((): string => {
    if (typeof window !== 'undefined') {
      const hostname = window.location.hostname;
      if (hostname === 'localhost' || hostname === '127.0.0.1') {
        return 'http://localhost:3002';
      } else {
        return `http://${hostname}:3002`;
      }
    }
    return '';
  }, []);

  // èªè¨¼ä»˜ãfetch
  const authenticatedFetch = useCallback(async (url: string, options: RequestInit = {}) => {
    const token = localStorage.getItem('access_token');
    return fetch(url, {
      ...options,
      headers: {
        ...options.headers,
        'Authorization': token ? `Bearer ${token}` : '',
        'Content-Type': 'application/json',
      },
    });
  }, []);

  // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç¤¾å“¡æƒ…å ±ã‚’å–å¾—
  const fetchCurrentStaff = useCallback(async () => {
    if (!user?.email) {
      console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“');
      return;
    }

    try {
      console.log('API URL:', getApiUrl());
      console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ¼ãƒ«:', user.email);
      
      const response = await authenticatedFetch(`${getApiUrl()}/api/staff`);
      console.log('ã‚¹ã‚¿ãƒƒãƒ•API ãƒ¬ã‚¹ãƒãƒ³ã‚¹çŠ¶æ…‹:', response.status);
      
      if (response.ok) {
        const staffList: Staff[] = await response.json();
        console.log('å–å¾—ã—ãŸã‚¹ã‚¿ãƒƒãƒ•ãƒªã‚¹ãƒˆ:', staffList);
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ¼ãƒ«ã‹ã‚‰ç¤¾å“¡ã‚’æ¤œç´¢
        let userStaff = staffList.find(staff => {
          // Contract ãƒ†ãƒ¼ãƒ–ãƒ«ã®emailã¨ãƒãƒƒãƒãƒ³ã‚°
          return staff.name.includes(user.email.split('@')[0]) || 
                 staff.empNo === user.email.split('@')[0];
        });
        
        if (!userStaff && staffList.length > 0) {
          console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¯¾å¿œã™ã‚‹ç¤¾å“¡ãŒè¦‹ã¤ã‹ã‚‰ãªã„ãŸã‚ã€æœ€åˆã®ç¤¾å“¡ã‚’ä½¿ç”¨');
          userStaff = staffList[0];
        }
        
        if (userStaff) {
          console.log('é¸æŠã•ã‚ŒãŸç¤¾å“¡:', userStaff);
          setCurrentStaff(userStaff);
          // è©³ç´°æƒ…å ±ã‚‚å–å¾—
          await fetchStaffDetails(userStaff.id);
        } else {
          setError('å¯¾å¿œã™ã‚‹ç¤¾å“¡æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        }
      } else {
        const errorText = await response.text();
        console.error('ã‚¹ã‚¿ãƒƒãƒ•API ã‚¨ãƒ©ãƒ¼:', response.status, errorText);
        setError(`ç¤¾å“¡æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${response.status}`);
      }
    } catch (err) {
      console.error('ç¤¾å“¡æƒ…å ±ã®å–å¾—ã«å¤±æ•—:', err);
      setError('ç¤¾å“¡æƒ…å ±ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    }
  }, [user, getApiUrl, authenticatedFetch]);

  // ã‚¹ã‚¿ãƒƒãƒ•è©³ç´°æƒ…å ±ã‚’å–å¾—
  const fetchStaffDetails = useCallback(async (staffId: number) => {
    try {
      const response = await authenticatedFetch(`${getApiUrl()}/api/staff/${staffId}/details`);
      if (response.ok) {
        const details: StaffDetails = await response.json();
        console.log('å–å¾—ã—ãŸè©³ç´°æƒ…å ±:', details);
        setStaffDetails(details);
      } else {
        console.error('è©³ç´°æƒ…å ±ã®å–å¾—ã«å¤±æ•—:', response.status);
      }
    } catch (err) {
      console.error('è©³ç´°æƒ…å ±ã®å–å¾—ã‚¨ãƒ©ãƒ¼:', err);
    }
  }, [getApiUrl, authenticatedFetch]);

  // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
  const fetchSchedules = useCallback(async () => {
    if (!currentStaff) {
      console.log('currentStaffãŒè¨­å®šã•ã‚Œã¦ã„ãªã„ãŸã‚ã€ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å–å¾—ã‚’ã‚¹ã‚­ãƒƒãƒ—');
      return;
    }

    console.log('ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å–å¾—é–‹å§‹:', {
      currentStaff: currentStaff.name,
      staffId: currentStaff.id,
      monthDays: monthDays.length
    });

    setLoading(true);
    setError(null);

    try {
      const promises = monthDays.map(async (day) => {
        const dateStr = format(day, 'yyyy-MM-dd');
        const url = `${getApiUrl()}/api/schedules/unified?date=${dateStr}&includeMasking=false`;
        console.log(`APIå‘¼ã³å‡ºã—: ${url}`);
        
        const response = await authenticatedFetch(url);
        
        if (response.ok) {
          const data = await response.json();
          console.log(`${dateStr}ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹:`, data);
          
          const filteredSchedules = data.schedules?.filter((schedule: Schedule) => 
            schedule.staffId === currentStaff.id
          ).map((schedule: Schedule) => ({
            ...schedule,
            _fetchDate: dateStr // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒã©ã®æ—¥ä»˜ã‹ã‚‰å–å¾—ã•ã‚ŒãŸã‹ã‚’è¨˜éŒ²
          })) || [];
          
          console.log(`${dateStr}ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å¾Œã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«:`, filteredSchedules);
          return filteredSchedules;
        } else {
          console.error(`${dateStr}ã®APIå‘¼ã³å‡ºã—å¤±æ•—:`, response.status);
          return [];
        }
      });

      const results = await Promise.all(promises);
      const allSchedules = results.flat();
      console.log('å…¨ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å–å¾—å®Œäº†:', {
        ç·ä»¶æ•°: allSchedules.length,
        ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«: allSchedules
      });
      
      // ãƒ‡ãƒãƒƒã‚°: æœ€åˆã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®æ§‹é€ ã‚’ç¢ºèª
      if (allSchedules.length > 0) {
        console.log('=== ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿æ§‹é€ ç¢ºèª ===');
        console.log('æœ€åˆã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«:', allSchedules[0]);
        console.log('start type:', typeof allSchedules[0].start);
        console.log('end type:', typeof allSchedules[0].end);
        console.log('staffId type:', typeof allSchedules[0].staffId);
      }
      
      setSchedules(allSchedules);
    } catch (err) {
      console.error('ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å–å¾—ã«å¤±æ•—:', err);
      setError('ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
    } finally {
      setLoading(false);
    }
  }, [currentStaff, monthDays, getApiUrl, authenticatedFetch]);

  // ãƒ‰ãƒ©ãƒƒã‚°ã‚ªãƒ¼ãƒãƒ¼å‡¦ç†
  const handleDragOver = useCallback((e: React.DragEvent) => {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
  }, []);

  // ãƒ‰ãƒ­ãƒƒãƒ—å‡¦ç†ï¼ˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æ™‚é–“å¤‰æ›´ï¼‰
  const handleDrop = useCallback(async (e: React.DragEvent, targetDate: Date) => {
    e.preventDefault();
    
    if (!draggedSchedule || !currentStaff) return;
    
    const rect = e.currentTarget.getBoundingClientRect();
    const dropX = e.clientX - rect.left - dragOffset;
    const dropPosition = (dropX / rect.width) * 100;
    const newStartTime = positionPercentToTime(dropPosition);
    
    const duration = (typeof draggedSchedule.end === 'number' ? draggedSchedule.end : 0) - 
                    (typeof draggedSchedule.start === 'number' ? draggedSchedule.start : 0);
    const newEndTime = newStartTime + duration;
    
    if (newEndTime > 21) {
      alert('21:00ã‚’è¶…ãˆã‚‹æ™‚é–“ã¯è¨­å®šã§ãã¾ã›ã‚“');
      return;
    }
    
    try {
      const response = await fetch(`${getApiUrl()}/api/schedules/${draggedSchedule.id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          start: newStartTime,
          end: newEndTime,
          date: format(targetDate, 'yyyy-MM-dd')
        })
      });
      
      if (response.ok) {
        // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æ›´æ–°æˆåŠŸå¾Œã¯ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰
        window.location.reload();
      } else {
        alert('ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    } catch (error) {
      console.error('ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
      alert('ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
    } finally {
      setDraggedSchedule(null);
      setDragOffset(0);
    }
  }, [draggedSchedule, dragOffset, currentStaff, fetchSchedules]);

  // åˆæœŸåŒ–å‡¦ç†
  useEffect(() => {
    if (!authLoading && user) {
      fetchCurrentStaff();
    }
  }, [authLoading, user, fetchCurrentStaff]);

  useEffect(() => {
    if (currentStaff) {
      fetchSchedules();
    }
  }, [currentStaff]);

  // ãƒ—ãƒªã‚»ãƒƒãƒˆäºˆå®šã‚’è¿½åŠ 
  const addPresetSchedule = useCallback(async (preset: PresetSchedule, targetDate: Date) => {
    if (!currentStaff) {
      console.error('ç¤¾å“¡æƒ…å ±ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
      setError('ç¤¾å“¡æƒ…å ±ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
      return;
    }

    const dateStr = format(targetDate, 'yyyy-MM-dd');
    console.log('ãƒ—ãƒªã‚»ãƒƒãƒˆäºˆå®šè¿½åŠ :', {
      preset,
      targetDate: dateStr,
      currentStaff: currentStaff.name
    });
    
    try {
      // è¤‡æ•°ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å¯¾å¿œ
      const schedulesToAdd = preset.multiSchedules || [{
        status: preset.status,
        startTime: preset.startTime,
        endTime: preset.endTime,
        memo: preset.memo
      }];

      // è¤‡æ•°ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’é †æ¬¡è¿½åŠ 
      for (const scheduleData of schedulesToAdd) {
        const newSchedule = {
          staffId: currentStaff.id,
          status: scheduleData.status,
          start: scheduleData.startTime,
          end: scheduleData.endTime,
          memo: scheduleData.memo || '',
          date: dateStr,
        };

        console.log('é€ä¿¡ãƒ‡ãƒ¼ã‚¿:', newSchedule);
        const url = `${getApiUrl()}/api/schedules`;
        console.log('API URL:', url);

        const response = await authenticatedFetch(url, {
          method: 'POST',
          body: JSON.stringify(newSchedule),
        });

        console.log('è¿½åŠ ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', response.status);

        if (!response.ok) {
          const errorData = await response.json();
          console.error('è¿½åŠ ã‚¨ãƒ©ãƒ¼:', errorData);
          setError(errorData.message || 'ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ');
          return;
        }
      }

      // å…¨ã¦æˆåŠŸã—ãŸå ´åˆ
      console.log('å…¨ãƒ—ãƒªã‚»ãƒƒãƒˆäºˆå®šè¿½åŠ æˆåŠŸ');
      
      // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å†å–å¾—
      await fetchSchedules();
      
      // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      setError(null);
      console.log('ãƒ—ãƒªã‚»ãƒƒãƒˆäºˆå®šã‚’è¿½åŠ ã—ã¾ã—ãŸ');
    } catch (err) {
      console.error('ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¿½åŠ ã‚¨ãƒ©ãƒ¼:', err);
      setError('ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  }, [currentStaff, getApiUrl, authenticatedFetch, fetchSchedules]);

  // ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ï¼ˆä¿®æ­£ç‰ˆï¼‰
  const handleTimelineMouseDown = useCallback((e: React.MouseEvent, targetDate: Date) => {
    // å³ã‚¯ãƒªãƒƒã‚¯ã®å ´åˆã¯ç„¡è¦–
    if (e.button !== 0) return;
    
    console.log('=== ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹ ===');
    console.log('targetDate:', targetDate);
    console.log('currentStaff:', currentStaff);
    
    const rect = e.currentTarget.getBoundingClientRect();
    const startX = e.clientX - rect.left;
    
    // ãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°ã§ãƒ‰ãƒ©ãƒƒã‚°æƒ…å ±ã‚’ç®¡ç†
    let currentX = startX;
    const rowElement = e.currentTarget as HTMLDivElement;
    
    // åˆæœŸçŠ¶æ…‹ã‚’è¨­å®š
    setDragInfo({
      date: targetDate,
      startX,
      currentX: startX,
      rowRef: rowElement,
    });
    
    // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå…¨ä½“ã§ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£
    const handleMouseMove = (moveEvent: MouseEvent) => {
      currentX = moveEvent.clientX - rect.left;
      
      // ãƒ‰ãƒ©ãƒƒã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ç”¨ã«çŠ¶æ…‹æ›´æ–°
      setDragInfo({
        date: targetDate,
        startX,
        currentX,
        rowRef: rowElement,
      });
    };
    
    const handleMouseUp = () => {
      console.log('=== ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº† ===');
      console.log('startX:', startX, 'currentX:', currentX);
      console.log('ãƒ‰ãƒ©ãƒƒã‚°è·é›¢:', Math.abs(currentX - startX));
      
      if (Math.abs(currentX - startX) > 5) {
        // ãƒ‰ãƒ©ãƒƒã‚°ãŒç™ºç”Ÿã—ãŸå ´åˆã€æ–°è¦ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ä½œæˆ
        const leftX = Math.min(startX, currentX);
        const rightX = Math.max(startX, currentX);
        
        console.log('leftX:', leftX, 'rightX:', rightX, 'rect.width:', rect.width);
        
        // 13æ™‚é–“åˆ†ï¼ˆ8:00-21:00ï¼‰ã‚’52ãƒã‚¹ï¼ˆ15åˆ†Ã—4ãƒã‚¹/æ™‚é–“ï¼‰ã«åˆ†å‰²
        const TIMELINE_HOURS = 13; // 21 - 8
        const QUARTERS_PER_HOUR = 4;
        const TOTAL_QUARTERS = TIMELINE_HOURS * QUARTERS_PER_HOUR; // 52ãƒã‚¹
        
        // Xåº§æ¨™ã‚’15åˆ†å˜ä½ã®ãƒã‚¹æ•°ã«å¤‰æ›
        const leftQuarter = (leftX / rect.width) * TOTAL_QUARTERS;
        const rightQuarter = (rightX / rect.width) * TOTAL_QUARTERS;
        
        // æœ€è¿‘å‚ã®15åˆ†å˜ä½ã«ã‚¹ãƒŠãƒƒãƒ—
        const snappedLeftQuarter = Math.round(leftQuarter);
        const snappedRightQuarter = Math.round(rightQuarter);
        
        // ãƒã‚¹æ•°ã‚’æ™‚åˆ»ã«å¤‰æ›
        const startTime = 8 + (snappedLeftQuarter / QUARTERS_PER_HOUR);
        const endTime = 8 + (snappedRightQuarter / QUARTERS_PER_HOUR);
        
        console.log('è¨ˆç®—çµæœ - startTime:', startTime, 'endTime:', endTime);
        
        // æœ€å°15åˆ†é–“ã®åˆ¶ç´„
        if (endTime - startTime >= 0.25) {
          const draggedData: Partial<Schedule> & { date?: string } = {
            staffId: currentStaff?.id,
            status: 'online',
            start: startTime,
            end: endTime,
            memo: '',
            staffName: currentStaff?.name || '',
            staffDepartment: currentStaff?.department || '',
            staffGroup: currentStaff?.group || '',
            date: format(targetDate, 'yyyy-MM-dd'),
          };
          
          console.log('=== ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—æ–°è¦äºˆå®šä½œæˆ ===');
          console.log('å¯¾è±¡æ—¥ä»˜:', format(targetDate, 'yyyy-MM-dd'));
          console.log('æ™‚é–“:', `${startTime} - ${endTime}`);
          console.log('ä½œæˆãƒ‡ãƒ¼ã‚¿:', draggedData);
          
          setDraggedSchedule(draggedData);
          console.log('ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã: setIsModalOpen(true)');
          setIsModalOpen(true);
          setEditingSchedule(null);
        } else {
          console.log('æœ€å°æ™‚é–“åˆ¶ç´„ã«ã‚ˆã‚Šä½œæˆã‚’ã‚¹ã‚­ãƒƒãƒ—');
        }
      } else {
        console.log('ãƒ‰ãƒ©ãƒƒã‚°è·é›¢ãŒä¸è¶³ã®ãŸã‚ä½œæˆã‚’ã‚¹ã‚­ãƒƒãƒ—');
      }
      
      // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
      setDragInfo(null);
      document.removeEventListener('mousemove', handleMouseMove);
      document.removeEventListener('mouseup', handleMouseUp);
    };
    
    document.addEventListener('mousemove', handleMouseMove);
    document.addEventListener('mouseup', handleMouseUp);
  }, [currentStaff]);

  // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ä¿å­˜ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ï¼ˆãƒ¡ã‚¤ãƒ³ç”»é¢ã¨åŒã˜ï¼‰
  const handleSaveSchedule = useCallback(async (scheduleData: any) => {
    console.log('ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ä¿å­˜:', scheduleData);
    
    try {
      const isEditing = scheduleData.id !== undefined;
      
      if (isEditing) {
        // ç·¨é›†ã®å ´åˆ
        const updateData = {
          status: scheduleData.status,
          start: scheduleData.start,
          end: scheduleData.end,
          memo: scheduleData.memo || '',
        };
        
        const response = await authenticatedFetch(`${getApiUrl()}/api/schedules/${scheduleData.id}`, {
          method: 'PATCH',
          body: JSON.stringify(updateData),
        });
        
        if (response.ok) {
          console.log('ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æ›´æ–°æˆåŠŸ');
          await fetchSchedules();
          setIsModalOpen(false);
          setEditingSchedule(null);
        } else {
          const errorData = await response.json();
          setError(errorData.message || 'ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      } else {
        // æ–°è¦ä½œæˆã®å ´åˆ
        const createData = {
          staffId: scheduleData.staffId || currentStaff?.id,
          status: scheduleData.status,
          start: typeof scheduleData.start === 'number' ? scheduleData.start : scheduleData.start,
          end: typeof scheduleData.end === 'number' ? scheduleData.end : scheduleData.end,
          memo: scheduleData.memo || '',
          date: scheduleData.date || format(new Date(), 'yyyy-MM-dd'),
        };
        
        const response = await authenticatedFetch(`${getApiUrl()}/api/schedules`, {
          method: 'POST',
          body: JSON.stringify(createData),
        });
        
        if (response.ok) {
          console.log('ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ä½œæˆæˆåŠŸ');
          await fetchSchedules();
          setIsModalOpen(false);
          setDraggedSchedule(null);
          setEditingSchedule(null);
        } else {
          const errorData = await response.json();
          setError(errorData.message || 'ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      }
    } catch (err) {
      console.error('ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ä¿å­˜ã‚¨ãƒ©ãƒ¼:', err);
      setError('ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    }
  }, [currentStaff, getApiUrl, authenticatedFetch, fetchSchedules]);

  // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å‰Šé™¤ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
  const handleDeleteSchedule = useCallback(async (scheduleId: number) => {
    console.log('ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å‰Šé™¤:', scheduleId);
    
    try {
      const response = await authenticatedFetch(`${getApiUrl()}/api/schedules/${scheduleId}`, {
        method: 'DELETE',
      });
      
      if (response.ok) {
        console.log('ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å‰Šé™¤æˆåŠŸ');
        await fetchSchedules();
        setDeletingScheduleId(null);
      } else {
        const errorData = await response.json();
        setError(errorData.message || 'ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    } catch (err) {
      console.error('ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', err);
      setError('ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    }
  }, [getApiUrl, authenticatedFetch, fetchSchedules]);

  // æœˆå¤‰æ›´ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
  const handleMonthChange = useCallback((direction: 'prev' | 'next') => {
    setSelectedDate(prev => {
      const newDate = new Date(prev);
      if (direction === 'prev') {
        newDate.setMonth(prev.getMonth() - 1);
      } else {
        newDate.setMonth(prev.getMonth() + 1);
      }
      return newDate;
    });
  }, []);

  // viewModeå¤‰æ›´æ™‚ã«localStorageã«ä¿å­˜
  const toggleViewMode = () => {
    const newMode = viewMode === 'normal' ? 'compact' : 'normal';
    setViewMode(newMode);
    if (typeof window !== 'undefined') {
      localStorage.setItem('callstatus-viewMode', newMode);
    }
  };

  // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è‰²ã¯ TimelineUtils.STATUS_COLORS ã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ¸ˆã¿
  const getStatusColor = useCallback((status: string): string => {
    return STATUS_COLORS[status] || '#6b7280';
  }, []);

  // æ™‚åˆ»æ–‡å­—åˆ—ã®å¤‰æ›
  const formatTime = useCallback((decimalTime: number): string => {
    const hours = Math.floor(decimalTime);
    const minutes = Math.round((decimalTime - hours) * 60);
    return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
  }, []);

  if (authLoading || loading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="animate-spin rounded-full h-32 w-32 border-b-2 border-blue-500"></div>
      </div>
    );
  }

  if (!user) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="text-red-500">ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™</div>
      </div>
    );
  }

  if (!currentStaff) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="text-red-500">ç¤¾å“¡æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50">
      {/* ãƒ¡ã‚¤ãƒ³ç”»é¢ã¨åŒã˜èªè¨¼ãƒ˜ãƒƒãƒ€ãƒ¼ */}
      <div className="bg-white shadow-sm border-b border-gray-200 px-6 py-3 flex justify-between items-center">
        <h1 className="text-lg font-semibold text-gray-900">
          å€‹äººã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
        </h1>
        <div className="flex items-center space-x-4">
          <a
            href="/"
            className="text-sm bg-blue-100 hover:bg-blue-200 text-blue-800 px-3 py-1 rounded border border-blue-300 transition-colors"
          >
            ğŸ“Š ãƒ¡ã‚¤ãƒ³ç”»é¢
          </a>
        </div>
      </div>

      <div className={`container mx-auto p-2 font-sans ${viewMode === 'compact' ? 'compact-mode' : ''}`}>
        {/* ãƒ¡ã‚¤ãƒ³ç”»é¢ã¨åŒã˜å½¢å¼ã®ãƒ˜ãƒƒãƒ€ãƒ¼ */}
        <header className="mb-2 flex justify-between items-center">
          <div className="flex items-center space-x-3">
            <div className="inline-flex rounded-md shadow-sm" role="group">
              <button 
                type="button" 
                onClick={() => handleMonthChange('prev')} 
                className="px-2 py-1 text-xs font-medium text-gray-900 bg-white border border-gray-200 rounded-l-lg hover:bg-gray-100 h-7"
              >
                &lt;
              </button>
              <button 
                type="button" 
                className="px-2 py-1 text-xs font-medium text-gray-900 bg-white border-t border-b border-gray-200 hover:bg-gray-100 h-7"
              >
                ä»Šæœˆ
              </button>
              <button 
                type="button" 
                onClick={() => handleMonthChange('next')} 
                className="px-2 py-1 text-xs font-medium text-gray-900 bg-white border border-gray-200 rounded-r-lg hover:bg-gray-100 h-7"
              >
                &gt;
              </button>
            </div>
            <div className="text-lg font-semibold text-gray-900">
              {format(selectedDate, 'yyyyå¹´Mæœˆdæ—¥(E)', { locale: ja })}
            </div>
          </div>

          <div className="flex items-center space-x-2">
            <button 
              onClick={toggleViewMode}
              title={`è¡¨ç¤ºå¯†åº¦: ${viewMode === 'normal' ? 'æ¨™æº–' : 'ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆ'}`}
              className={`toggle-switch ${viewMode === 'compact' ? 'active' : ''}`}
            >
              <div className={`toggle-thumb ${viewMode === 'compact' ? 'active' : ''}`}></div>
            </button>
          </div>
        </header>

        {/* å€‹äººæƒ…å ±è¡¨ç¤º - ãƒ¡ã‚¤ãƒ³ç”»é¢ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼éƒ¨åˆ†ã¨åŒã˜æ§‹æˆ */}
        <div className="mb-2 p-2 bg-gray-50 rounded-lg">
          {staffDetails && (
            <div className="space-y-1">
              <div className="text-sm text-gray-700 flex flex-wrap items-center gap-4 ml-2">
                <span className="flex items-center gap-1">
                  <span className="font-bold">åå‰ï¼š</span>
                  <span className="px-2 py-1 bg-blue-50 text-blue-700 rounded text-sm">{currentStaff.name}</span>
                </span>
                <span className="flex items-center gap-1">
                  <span className="font-bold">ç¤¾å“¡ç•ªå·ï¼š</span>
                  <span className="px-2 py-1 bg-blue-50 text-blue-700 rounded text-sm">{staffDetails.empNo || 'æœªè¨­å®š'}</span>
                </span>
                <span className="flex items-center gap-1">
                  <span className="font-bold">éƒ¨ç½²ï¼š</span>
                  <span className="px-2 py-1 bg-blue-50 text-blue-700 rounded text-sm">{staffDetails.department}</span>
                </span>
                <span className="flex items-center gap-1">
                  <span className="font-bold">ã‚°ãƒ«ãƒ¼ãƒ—ï¼š</span>
                  <span className="px-2 py-1 bg-blue-50 text-blue-700 rounded text-sm">{staffDetails.group}</span>
                </span>
              </div>
              {/* å¥‘ç´„å‹¤å‹™æ™‚é–“ï¼ˆæ¨ªä¸¦ã³ã§è¡¨ç¤ºï¼‰ */}
              {staffDetails.contract && staffDetails.contract.workingDays.length > 0 && (
                <div className="text-sm text-gray-600 flex items-center gap-2 flex-wrap ml-2">
                  <span className="font-bold">å‹¤å‹™æ™‚é–“ï¼š</span>
                  {staffDetails.contract.workingDays.map((day, index) => (
                    <span key={index} className="px-2 py-1 bg-blue-50 text-blue-700 rounded text-sm">
                      {day}
                    </span>
                  ))}
                </div>
              )}
            </div>
          )}
        </div>

        {/* ã‚¨ãƒ©ãƒ¼è¡¨ç¤º */}
        {error && (
          <div className="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
            <div className="text-red-800">{error}</div>
          </div>
        )}

        {/* ãƒ—ãƒªã‚»ãƒƒãƒˆäºˆå®šãƒœã‚¿ãƒ³ */}
        <div className="sticky top-0 z-20 bg-white rounded-lg shadow-md p-6 mb-6 border-b">
          <h3 className="text-lg font-semibold text-gray-900 mb-4">ã‚¯ã‚¤ãƒƒã‚¯äºˆå®šè¿½åŠ </h3>
          <div className="mb-4 text-sm text-gray-600">
            ğŸ“Œ ä»Šæ—¥ã®äºˆå®šã‚’è¿½åŠ ã€ã¾ãŸã¯ä¸‹ã®æ—¥ä»˜ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç‰¹å®šã®æ—¥ã«è¿½åŠ 
          </div>
          <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-3">
            {presetSchedules.map((preset) => (
              <button
                key={preset.id}
                onClick={() => {
                  const targetDate = selectedDateForPreset || new Date();
                  addPresetSchedule(preset, targetDate);
                }}
                className="px-2 py-1 text-xs border border-gray-200 rounded hover:bg-gray-50 transition-colors"
                style={{ borderLeftColor: getStatusColor(preset.status), borderLeftWidth: '4px' }}
              >
                <div className="font-medium text-gray-900 text-center whitespace-pre-line text-xs">
                  {preset.multiSchedules ? (
                    `${preset.name}\nè¤‡æ•°æ™‚é–“å¸¯`
                  ) : (
                    `${preset.name}\n${formatTime(preset.startTime)}-${formatTime(preset.endTime)}`
                  )}
                </div>
              </button>
            ))}
          </div>
          {selectedDateForPreset && (
            <div className="mt-3 p-2 bg-blue-50 rounded border border-blue-200">
              <div className="text-sm text-blue-800">
                ğŸ“… {format(selectedDateForPreset, 'Mæœˆdæ—¥(E)', { locale: ja })} ã«è¿½åŠ ã—ã¾ã™
                <button
                  onClick={() => setSelectedDateForPreset(null)}
                  className="ml-2 text-blue-600 hover:text-blue-800 underline"
                >
                  ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
              </div>
            </div>
          )}
        </div>

        {/* æœˆé–“ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆï¼ˆãƒ¡ã‚¤ãƒ³ç”»é¢ã¨åŒã˜æ§‹é€ ï¼‰ */}
        <div className="bg-white rounded-lg shadow-sm overflow-hidden">
          <div className="p-6 border-b border-gray-200">
            <h3 className="text-lg font-semibold text-gray-900">æœˆé–“ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</h3>
          </div>
          
          <div className="bg-white shadow rounded-lg relative">
            <div className="flex">
              {/* å·¦åˆ—: æ—¥ä»˜åˆ—ï¼ˆå›ºå®šï¼‰ */}
              <div className="min-w-fit max-w-[120px] sticky left-0 z-20 bg-white border-r border-gray-200">
                {/* ä¸Šéƒ¨ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ç”¨ã®ã‚¹ãƒšãƒ¼ã‚µãƒ¼ */}
                <div className="h-[17px] bg-gray-50 border-b"></div>
                {/* ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ - æ™‚åˆ»è¡Œã¨åŒã˜é«˜ã•ã«èª¿æ•´ */}
                <div className="px-2 py-2 bg-gray-100 font-bold text-gray-600 text-sm text-center border-b whitespace-nowrap">æ—¥ä»˜</div>
                {/* æ—¥ä»˜è¡Œ */}
                {monthDays.map((day) => (
                  <div key={day.toISOString()} className={`px-2 text-sm font-medium whitespace-nowrap h-[${viewMode === 'compact' ? '32' : '45'}px] hover:bg-gray-50 flex items-center border-b`}>
                    {format(day, 'M/d E', { locale: ja })}
                  </div>
                ))}
              </div>
              
              {/* å³åˆ—: ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ */}
              <div className="flex-1 flex flex-col">
                {/* ä¸Šéƒ¨ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ */}
                <div className="overflow-x-auto border-b">
                  <div className="min-w-[1300px] h-[17px]"></div>
                </div>
                
                {/* æ™‚é–“ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆé€šå¸¸è¡¨ç¤ºï¼‰ */}
                <div className="bg-gray-100 border-b overflow-hidden">
                  <div className="min-w-[1300px]">
                    <div className="flex font-bold text-sm">
                      {Array.from({ length: 13 }).map((_, i) => {
                        const hour = 8 + i;
                        const isEarlyOrNight = hour === 8 || hour >= 18; // 8:00ã¨18:00ä»¥é™ã‚’ç‰¹åˆ¥æ‰±ã„
                        const width = `${(4 / 52) * 100}%`; // 4ãƒã‚¹åˆ† = 1æ™‚é–“åˆ†ã®å¹…
                        return (
                          <div 
                            key={hour} 
                            className={`text-left pl-2 border-r py-2 whitespace-nowrap ${isEarlyOrNight ? 'bg-blue-50' : ''}`}
                            style={{ width }}
                            title={`${hour}:00 ${isEarlyOrNight ? '(ç‰¹åˆ¥æ™‚é–“å¸¯)' : ''}`}
                          >
                            {hour}:00
                          </div>
                        );
                      })}
                    </div>
                    </div>
                  </div>
                </div>
                
                {/* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */}
                <div className="flex-1 overflow-x-auto">
                  <div className="min-w-[1300px] relative">
                    {/* 15åˆ†å˜ä½ã®ç›®ç››ã‚Šï¼ˆå…¨ä½“ï¼‰ */}
                    {(() => {
                      const markers = [];
                      for (let hour = 8; hour <= 21; hour++) {
                        for (let minute = 0; minute < 60; minute += 15) {
                          if (hour === 21 && minute > 0) break;
                          const time = hour + minute / 60;
                          const position = timeToPositionPercent(time);
                          const timeString = `${hour}:${String(minute).padStart(2, '0')}`;
                          
                          markers.push(
                            <div
                              key={`${hour}-${minute}`}
                              className="absolute top-0 bottom-0 w-0.5 border-l border-gray-300 z-5 opacity-50"
                              style={{ left: `${position}%` }}
                              title={timeString}
                            />
                          );
                        }
                      }
                      return markers;
                    })()}
                    
                    {/* æ—©æœã‚¨ãƒªã‚¢ï¼ˆ8:00-9:00ï¼‰ã®èƒŒæ™¯å¼·èª¿ */}
                    <div className="absolute top-0 bottom-0 bg-blue-50 opacity-30 z-10" 
                         style={{ left: `0%`, width: `${((9-8)*4)/52*100}%` }} 
                         title="æ—©æœæ™‚é–“å¸¯ï¼ˆ8:00-9:00ï¼‰">
                    </div>
                    
                    {/* å¤œé–“ã‚¨ãƒªã‚¢ï¼ˆ18:00-21:00ï¼‰ã®èƒŒæ™¯å¼·èª¿ */}
                    <div className="absolute top-0 bottom-0 bg-blue-50 opacity-30 z-10" 
                         style={{ left: `${((18-8)*4)/52*100}%`, width: `${((21-18)*4)/52*100}%` }} 
                         title="å¤œé–“æ™‚é–“å¸¯ï¼ˆ18:00-21:00ï¼‰">
                    </div>

                    {/* å„æ—¥ã®è¡Œ */}
                    {monthDays.map((day) => {
                      const daySchedules = schedules.filter(schedule => {
                        const dayDateStr = format(day, 'yyyy-MM-dd');
                        return schedule._fetchDate === dayDateStr;
                      });
                      
                      const isCurrentDay = isToday(day);
                      const getCurrentTimePosition = () => {
                        if (!isCurrentDay) return null;
                        const currentDecimalHour = currentTime.getHours() + currentTime.getMinutes() / 60;
                        if (currentDecimalHour < 8 || currentDecimalHour >= 21) return null;
                        return timeToPositionPercent(currentDecimalHour);
                      };
                      const currentTimePosition = getCurrentTimePosition();
                      
                      return (
                        <div key={day.getTime()} 
                             className={`relative border-b border-gray-100 hover:bg-gray-50 ${getRowHeight()}`}
                             onMouseDown={(e) => handleTimelineMouseDown(e, day)}
                             onDrop={(e) => handleDrop(e, day)}
                             onDragOver={handleDragOver}>
                          
                          {/* ç¾åœ¨æ™‚åˆ»ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ */}
                          {currentTimePosition !== null && (
                            <div className="absolute top-0 bottom-0 w-0.5 bg-red-500 z-30" 
                                 style={{ left: `${currentTimePosition}%` }} 
                                 title={`ç¾åœ¨æ™‚åˆ»: ${currentTime.getHours()}:${String(currentTime.getMinutes()).padStart(2, '0')}`}>
                            </div>
                          )}

                      {/* ãƒ‰ãƒ©ãƒƒã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ï¼ˆãƒ¡ã‚¤ãƒ³ç”»é¢ã¨åŒã˜ï¼‰ */}
                      {dragInfo && isSameDay(dragInfo.date, day) && (
                        (() => {
                          const leftX = Math.min(dragInfo.startX, dragInfo.currentX);
                          const rightX = Math.max(dragInfo.startX, dragInfo.currentX);
                          const width = rightX - leftX;
                          
                          if (width < 5) return null; // æœ€å°å¹…ãƒã‚§ãƒƒã‚¯
                          
                          const leftPercent = (leftX / dragInfo.rowRef.clientWidth) * 100;
                          const widthPercent = (width / dragInfo.rowRef.clientWidth) * 100;
                          
                          return (
                            <div
                              className="absolute bg-blue-400 opacity-50 border-2 border-blue-600 rounded z-20"
                              style={{
                                left: `${leftPercent}%`,
                                width: `${widthPercent}%`,
                                top: '50%',
                                transform: 'translateY(-50%)',
                                height: viewMode === 'compact' ? '16px' : '24px',
                              }}
                            />
                          );
                        })()
                      )}

                      {/* ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒãƒ¼ï¼ˆãƒ¡ã‚¤ãƒ³ç”»é¢ã¨åŒã˜ã‚¹ã‚¿ã‚¤ãƒ«ï¼‰ */}
                      {daySchedules.map((schedule, index) => {
                        let startHour: number;
                        let endHour: number;
                        
                        // ãƒ‡ãƒãƒƒã‚°: schedule.startã®å‹ã‚’ç¢ºèª
                        if (format(day, 'yyyy-MM-dd') === '2025-06-25' && schedule.staffId === 214) {
                          console.log('schedule.start type:', typeof schedule.start, 'value:', schedule.start);
                          console.log('schedule.end type:', typeof schedule.end, 'value:', schedule.end);
                          console.log('full schedule:', schedule);
                        }
                        
                        if (typeof schedule.start === 'number') {
                          startHour = schedule.start;
                          endHour = schedule.end as number;
                        } else {
                          const startDate = new Date(schedule.start as Date);
                          const endDate = new Date(schedule.end as Date);
                          startHour = startDate.getHours() + startDate.getMinutes() / 60;
                          endHour = endDate.getHours() + endDate.getMinutes() / 60;
                        }

                        const startPosition = timeToPositionPercent(startHour);
                        const endPosition = timeToPositionPercent(endHour);
                        const barWidth = endPosition - startPosition;
                        const isContract = schedule.layer === 'contract';
                        const isHistorical = schedule.layer === 'historical' || schedule.isHistorical;
                        
                        // ãƒ‡ãƒãƒƒã‚°: è¡¨ç¤ºä½ç½®ã®è¨ˆç®—ã‚’ç¢ºèª
                        if (format(day, 'yyyy-MM-dd') === '2025-06-25' && schedule.staffId === 214) {
                          console.log(`Schedule barè¨ˆç®—:`, {
                            startHour,
                            endHour,
                            startPosition,
                            endPosition,
                            barWidth,
                            isContract,
                            isHistorical
                          });
                        }

                        return (
                          <div
                            key={`${schedule.id}-${schedule.layer}-${index}`}
                            className={`schedule-block absolute ${getScheduleBarHeight()} rounded text-white text-xs flex items-center justify-between px-2 group ${
                              isContract || isHistorical ? 'cursor-default' : 'cursor-pointer hover:opacity-80'
                            } ${
                              isHistorical ? 'border-2 border-dashed border-gray-400' : ''
                            } ${
                              // é¸æŠçŠ¶æ…‹ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼ˆãƒ¡ã‚¤ãƒ³ç”»é¢ã¨åŒæ§˜ï¼‰
                              selectedSchedule && 
                              selectedSchedule.schedule.id === schedule.id && 
                              selectedSchedule.layer === (schedule.layer || 'adjustment')
                                ? 'ring-2 ring-yellow-400 ring-offset-1'
                                : ''
                            }`}
                            draggable={!isContract && !isHistorical && canEdit(schedule.staffId)}
                            onDragStart={(e) => {
                              if (!isContract && !isHistorical && canEdit(schedule.staffId)) {
                                const rect = e.currentTarget.getBoundingClientRect();
                                const clickX = e.clientX - rect.left;
                                setDragOffset(clickX);
                                setDraggedSchedule({
                                  ...schedule,
                                  date: format(day, 'yyyy-MM-dd')
                                });
                                e.dataTransfer.effectAllowed = 'move';
                              }
                            }}
                            onDragEnd={() => {
                              setDraggedSchedule(null);
                              setDragOffset(0);
                            }}
                            style={{
                              left: `${startPosition}%`,
                              width: `${barWidth}%`,
                              top: '50%',
                              transform: 'translateY(-50%)',
                              backgroundColor: getStatusColor(schedule.status),
                              opacity: isContract ? 0.5 : isHistorical ? 0.8 : 1,
                              backgroundImage: isContract 
                                ? 'repeating-linear-gradient(45deg, transparent, transparent 2px, rgba(255,255,255,0.3) 2px, rgba(255,255,255,0.3) 4px)' 
                                : isHistorical 
                                ? 'repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255,255,255,0.15) 10px, rgba(255,255,255,0.15) 20px)'
                                : 'none',
                              zIndex: isContract ? 10 : isHistorical ? 15 : 30,
                            }}
                            onClick={(e) => {
                              e.stopPropagation();
                              if (!isContract && !isHistorical && canEdit(schedule.staffId)) {
                                const scheduleLayer = schedule.layer || 'adjustment';
                                const currentSelection = selectedSchedule;
                                
                                if (currentSelection && 
                                    currentSelection.schedule.id === schedule.id && 
                                    currentSelection.layer === scheduleLayer) {
                                  // åŒã˜äºˆå®šã‚’å†ã‚¯ãƒªãƒƒã‚¯ â†’ ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
                                  handleOpenModal(schedule);
                                  setSelectedSchedule(null);
                                } else {
                                  // ç•°ãªã‚‹äºˆå®šã‚’ã‚¯ãƒªãƒƒã‚¯ â†’ é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
                                  setSelectedSchedule({ schedule, layer: scheduleLayer });
                                }
                              }
                            }}
                          >
                            <span className="truncate">
                              {capitalizeStatus(schedule.status)}
                              {schedule.memo && (
                                <span className="ml-1 text-yellow-200">ğŸ“</span>
                              )}
                            </span>
                            {!isContract && !isHistorical && (
                              <button 
                                onClick={(e) => { 
                                  e.stopPropagation(); 
                                  setDeletingScheduleId(schedule.id); 
                                }} 
                                className="text-white hover:text-red-200 ml-2 opacity-0 group-hover:opacity-100 transition-opacity"
                              >
                                Ã—
                              </button>
                            )}
                          </div>
                        );
                      })}
                      </div>
                    );
                  })}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        {/* ãƒ¡ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚‹ãƒªãƒ³ã‚¯ */}
        <div className="mt-6 text-center">
          <a
            href="/"
            className="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50"
          >
            ãƒ¡ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚‹
          </a>
        </div>

        {/* ãƒ¢ãƒ¼ãƒ€ãƒ« */}
        <ScheduleModal 
          isOpen={isModalOpen} 
          onClose={() => {
            setIsModalOpen(false);
            setDraggedSchedule(null);
            setEditingSchedule(null);
          }} 
          staffList={currentStaff ? [currentStaff] : []} 
          onSave={handleSaveSchedule} 
          scheduleToEdit={editingSchedule} 
          initialData={draggedSchedule || undefined} 
        />
        <ConfirmationModal 
          isOpen={deletingScheduleId !== null} 
          onClose={() => setDeletingScheduleId(null)} 
          onConfirm={() => { if (deletingScheduleId) handleDeleteSchedule(deletingScheduleId); }} 
          message="ã“ã®äºˆå®šã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ" 
        />
      </div>
    </div>
  );
};

// ScheduleModal ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
const ScheduleModal = ({ isOpen, onClose, staffList, onSave, scheduleToEdit, initialData }: { 
  isOpen: boolean; 
  onClose: () => void; 
  staffList: Staff[]; 
  onSave: (data: any) => void;
  scheduleToEdit: Schedule | null;
  initialData?: Partial<Schedule> & { date?: string };
}) => {
  const [selectedStaff, setSelectedStaff] = useState<number | ''>('');
  const [selectedStatus, setSelectedStatus] = useState<string>('');
  const [startTime, setStartTime] = useState<number>(9);
  const [endTime, setEndTime] = useState<number>(18);
  const [memo, setMemo] = useState<string>('');

  const timeOptions = useMemo(() => generateTimeOptions(8, 21), []);

  useEffect(() => {
    if (isOpen) {
      console.log('=== ScheduleModal useEffect ===');
      console.log('scheduleToEdit:', scheduleToEdit);
      console.log('initialData:', initialData);
      console.log('staffList:', staffList);
      
      if (scheduleToEdit) {
        // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰
        console.log('ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§ãƒ¢ãƒ¼ãƒ€ãƒ«åˆæœŸåŒ–');
        setSelectedStaff(scheduleToEdit.staffId);
        setSelectedStatus(scheduleToEdit.status);
        setStartTime(typeof scheduleToEdit.start === 'number' ? scheduleToEdit.start : 9);
        setEndTime(typeof scheduleToEdit.end === 'number' ? scheduleToEdit.end : 18);
        setMemo(scheduleToEdit.memo || '');
      } else if (initialData) {
        // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã¾ãŸã¯ãƒ—ãƒªã‚»ãƒƒãƒˆã‹ã‚‰ã®æ–°è¦ä½œæˆ
        console.log('initialDataã‚’ä½¿ç”¨ã—ã¦ãƒ¢ãƒ¼ãƒ€ãƒ«åˆæœŸåŒ–');
        console.log('è¨­å®šå€¤ - staffId:', initialData.staffId, 'status:', initialData.status, 'start:', initialData.start, 'end:', initialData.end);
        setSelectedStaff(initialData.staffId || (staffList.length > 0 ? staffList[0].id : ''));
        setSelectedStatus(initialData.status || 'online');
        setStartTime(typeof initialData.start === 'number' ? initialData.start : 9);
        setEndTime(typeof initialData.end === 'number' ? initialData.end : 18);
        setMemo(initialData.memo || '');
      } else {
        // ç©ºã®æ–°è¦ä½œæˆ
        console.log('ç©ºã®æ–°è¦ä½œæˆã§ãƒ¢ãƒ¼ãƒ€ãƒ«åˆæœŸåŒ–');
        setSelectedStaff(staffList.length > 0 ? staffList[0].id : '');
        setSelectedStatus('online');
        setStartTime(9);
        setEndTime(18);
        setMemo('');
      }
    }
  }, [isOpen, scheduleToEdit, initialData, staffList]);

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    
    console.log('=== ScheduleModal handleSubmit ===');
    console.log('ãƒ•ã‚©ãƒ¼ãƒ å€¤ - selectedStaff:', selectedStaff, 'selectedStatus:', selectedStatus);
    console.log('ãƒ•ã‚©ãƒ¼ãƒ å€¤ - startTime:', startTime, 'endTime:', endTime, 'memo:', memo);
    console.log('initialData?.date:', initialData?.date);
    
    if (!selectedStaff || !selectedStatus) {
      console.log('ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼: ã‚¹ã‚¿ãƒƒãƒ•ã¾ãŸã¯ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒæœªé¸æŠ');
      alert('ã‚¹ã‚¿ãƒƒãƒ•ã¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„');
      return;
    }
    
    if (startTime >= endTime) {
      console.log('ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼: é–‹å§‹æ™‚åˆ»ãŒçµ‚äº†æ™‚åˆ»ä»¥é™');
      alert('é–‹å§‹æ™‚åˆ»ã¯çµ‚äº†æ™‚åˆ»ã‚ˆã‚Šå‰ã«è¨­å®šã—ã¦ãã ã•ã„');
      return;
    }

    const scheduleData = {
      id: scheduleToEdit?.id,
      staffId: Number(selectedStaff),
      status: selectedStatus,
      start: startTime,
      end: endTime,
      memo: memo,
      date: initialData?.date, // ãƒ‰ãƒ©ãƒƒã‚°ä½œæˆæ™‚ã®æ—¥ä»˜æƒ…å ±ã‚’å«ã‚ã‚‹
    };

    console.log('é€ä¿¡ã™ã‚‹scheduleData:', scheduleData);
    onSave(scheduleData);
  };

  if (!isOpen) {
    console.log('ScheduleModal: isOpen=false ãªã®ã§è¡¨ç¤ºã—ãªã„');
    return null;
  }
  
  console.log('ScheduleModal: è¡¨ç¤ºä¸­ isOpen=true');

  return createPortal(
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div className="bg-white rounded-lg p-6 w-full max-w-md">
        <h2 className="text-lg font-bold mb-4">
          {scheduleToEdit ? 'ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç·¨é›†' : 'ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¿½åŠ '}
        </h2>
        
        <form onSubmit={handleSubmit} className="space-y-4">
          {/* ã‚¹ã‚¿ãƒƒãƒ•é¸æŠ */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              ã‚¹ã‚¿ãƒƒãƒ•
            </label>
            <select
              value={selectedStaff}
              onChange={(e) => setSelectedStaff(e.target.value === '' ? '' : Number(e.target.value))}
              className="w-full border border-gray-300 rounded-md px-3 py-2"
              required
              disabled={staffList.length <= 1}
            >
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              {staffList.map((staff) => (
                <option key={staff.id} value={staff.id}>
                  {staff.name} ({staff.department} - {staff.group})
                </option>
              ))}
            </select>
          </div>

          {/* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é¸æŠ */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
            </label>
            <select
              value={selectedStatus}
              onChange={(e) => setSelectedStatus(e.target.value)}
              className="w-full border border-gray-300 rounded-md px-3 py-2"
              required
            >
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              {availableStatuses.map((status) => (
                <option key={status} value={status}>
                  {capitalizeStatus(status)}
                </option>
              ))}
            </select>
          </div>

          {/* é–‹å§‹æ™‚åˆ» */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              é–‹å§‹æ™‚åˆ»
            </label>
            <select
              value={startTime}
              onChange={(e) => {
                const newStartTime = Number(e.target.value);
                setStartTime(newStartTime);
                if (newStartTime >= endTime) {
                  setEndTime(Math.min(newStartTime + 1, 21));
                }
              }}
              className="w-full border border-gray-300 rounded-md px-3 py-2"
            >
              {timeOptions.slice(0, -1).map((option) => (
                <option key={option.value} value={option.value}>
                  {option.label}
                </option>
              ))}
            </select>
          </div>

          {/* çµ‚äº†æ™‚åˆ» */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              çµ‚äº†æ™‚åˆ»
            </label>
            <select
              value={endTime}
              onChange={(e) => setEndTime(Number(e.target.value))}
              className="w-full border border-gray-300 rounded-md px-3 py-2"
            >
              {timeOptions.filter(option => option.value > startTime).map((option) => (
                <option key={option.value} value={option.value}>
                  {option.label}
                </option>
              ))}
            </select>
          </div>

          {/* ãƒ¡ãƒ¢ */}
          {(selectedStatus === 'meeting' || selectedStatus === 'training') && (
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                ãƒ¡ãƒ¢
              </label>
              <input
                type="text"
                value={memo}
                onChange={(e) => setMemo(e.target.value)}
                className="w-full border border-gray-300 rounded-md px-3 py-2"
                placeholder="è©³ç´°ã‚’å…¥åŠ›..."
              />
            </div>
          )}

          {/* ãƒœã‚¿ãƒ³ */}
          <div className="flex space-x-3 pt-4">
            <button
              type="button"
              onClick={onClose}
              className="flex-1 px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50"
            >
              ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            </button>
            <button
              type="submit"
              className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700"
            >
              {scheduleToEdit ? 'æ›´æ–°' : 'è¿½åŠ '}
            </button>
          </div>
        </form>
      </div>
    </div>,
    document.body
  );
};

// ConfirmationModal ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
const ConfirmationModal = ({ isOpen, onClose, onConfirm, message }: { 
  isOpen: boolean; 
  onClose: () => void; 
  onConfirm: () => void; 
  message: string; 
}) => {
  if (!isOpen) return null;

  return createPortal(
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div className="bg-white rounded-lg p-6 w-full max-w-sm">
        <h3 className="text-lg font-medium text-gray-900 mb-4">
          ç¢ºèª
        </h3>
        <p className="text-sm text-gray-500 mb-6">
          {message}
        </p>
        <div className="flex space-x-3">
          <button
            type="button"
            onClick={onClose}
            className="flex-1 px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50"
          >
            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
          </button>
          <button
            type="button"
            onClick={onConfirm}
            className="flex-1 px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700"
          >
            å‰Šé™¤
          </button>
        </div>
      </div>
    </div>,
    document.body
  );
};

export default PersonalSchedulePage;